{
  "comments": [
    {
      "key": {
        "uuid": "97d032d3_e69ad6e1",
        "filename": "rtc_tools/video_file_writer.cc",
        "patchSetId": 1
      },
      "lineNbr": 45,
      "author": {
        "id": 5087
      },
      "writtenOn": "2019-03-15T07:58:31Z",
      "side": 1,
      "message": "This is triggering on some android bots:\n\nC  300.087s Main  # Fatal error in: ../../rtc_tools/video_file_writer.cc, line 45\nC  300.087s Main  # last system error: 2\nC  300.087s Main  # Check failed: buffer\nC  300.088s Main  # While trying to create: /sdcard/chromium_tests_root//test_videoi39qKB/test_video_file2.y4m[ CRASHED      ]\n\nhttps://ci.chromium.org/p/webrtc/builders/try/android_arm_rel/5338",
      "range": {
        "startLine": 45,
        "startChar": 4,
        "endLine": 45,
        "endChar": 65
      },
      "revId": "10eccb50b251f3e94fcb680446c10dd272fa1902",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d6f587bd_8c0b90b6",
        "filename": "rtc_tools/video_file_writer_unittest.cc",
        "patchSetId": 1
      },
      "lineNbr": 27,
      "author": {
        "id": 5087
      },
      "writtenOn": "2019-03-14T16:53:55Z",
      "side": 1,
      "message": "I should find some time to finish my CL to create a scoped temp dir, using the out/ folder is another widespread workaround. :)",
      "range": {
        "startLine": 27,
        "startChar": 36,
        "endLine": 27,
        "endChar": 62
      },
      "revId": "10eccb50b251f3e94fcb680446c10dd272fa1902",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f883da5f_49fefe14",
        "filename": "rtc_tools/video_file_writer_unittest.cc",
        "patchSetId": 1
      },
      "lineNbr": 27,
      "author": {
        "id": 7285
      },
      "writtenOn": "2019-03-14T17:18:10Z",
      "side": 1,
      "message": "Yes, that would be really handy. For instance, webrtc::test::RemoveDir only works with empty dirs, so we have to manually delete the files one by one.\nIs there a bug opened?",
      "parentUuid": "d6f587bd_8c0b90b6",
      "range": {
        "startLine": 27,
        "startChar": 36,
        "endLine": 27,
        "endChar": 62
      },
      "revId": "10eccb50b251f3e94fcb680446c10dd272fa1902",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "84fb0f2f_ff25bebb",
        "filename": "rtc_tools/video_file_writer_unittest.cc",
        "patchSetId": 1
      },
      "lineNbr": 27,
      "author": {
        "id": 5087
      },
      "writtenOn": "2019-03-15T07:57:06Z",
      "side": 1,
      "message": "Not yet but there is a CL (something I started weeks ago). Next week I will dedicate some time, feel free to add comments there.",
      "parentUuid": "f883da5f_49fefe14",
      "range": {
        "startLine": 27,
        "startChar": 36,
        "endLine": 27,
        "endChar": 62
      },
      "revId": "10eccb50b251f3e94fcb680446c10dd272fa1902",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "8c93efe1_a011fd98",
        "filename": "rtc_tools/video_file_writer_unittest.cc",
        "patchSetId": 1
      },
      "lineNbr": 27,
      "author": {
        "id": 5234
      },
      "writtenOn": "2019-03-15T08:28:25Z",
      "side": 1,
      "message": "Not sure if that refactoring is worth the effort. But for lack of scoped temp dir, maybe it\u0027s easiest to use webrtc::test::TempFilename for each file?\n\nI don\u0027t think GenerateTempFilename is ever a good idea; deleting the file and recreating it defeats the efforts to avoid races in TempFilename.\n\nIt might also make sense to change WriteVideoToFile to take a FILE* rather than a filename, then one could consider using the plain C tmpfile function.",
      "parentUuid": "84fb0f2f_ff25bebb",
      "range": {
        "startLine": 27,
        "startChar": 36,
        "endLine": 27,
        "endChar": 62
      },
      "revId": "10eccb50b251f3e94fcb680446c10dd272fa1902",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "cd9793af_4275851e",
        "filename": "rtc_tools/video_file_writer_unittest.cc",
        "patchSetId": 1
      },
      "lineNbr": 27,
      "author": {
        "id": 7285
      },
      "writtenOn": "2019-03-15T14:11:13Z",
      "side": 1,
      "message": "TempFilename adds the random bits as a suffix (e.g. \"video.y4ms8fena\") which prevents the writter to \"detect\" the format via the extension.\n\nI find the deletion by GenerateTempFilename a bit confusing, but I don\u0027t see how it makes it more \"racy\". In both case we rely on the uniqueness of the name.",
      "parentUuid": "8c93efe1_a011fd98",
      "range": {
        "startLine": 27,
        "startChar": 36,
        "endLine": 27,
        "endChar": 62
      },
      "revId": "10eccb50b251f3e94fcb680446c10dd272fa1902",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "23b7294d_501b8d40",
        "filename": "rtc_tools/video_file_writer_unittest.cc",
        "patchSetId": 1
      },
      "lineNbr": 27,
      "author": {
        "id": 5234
      },
      "writtenOn": "2019-03-15T15:02:01Z",
      "side": 1,
      "message": "\u003e I find the deletion by GenerateTempFilename a bit confusing, but I don\u0027t see how it makes it more \"racy\". In both case we rely on the uniqueness of the name.\n\nMultiple processes or threads calling TempFilename (backed by mkstemp) are guaranteed to never interfere with other\u0027s files, *even* if they\u0027re unlucky with the randomly added characters. Since the O_EXCL | O_CREAT flags are passed to the open syscall. Then open might fail with EEXIST, and in that case mkstemp will either fail, or try again with a new random name (not sure which).\n\nIf you delete and reopen the file, that guarantee is lost. And evil processes might also interfere, e.g., using the window between delete and reopen to create a symlink to some important file, which the unsuspecting application using a \"temporary\" file will then overwrite.\n\nNow, I think CreateDir has an implied O_CREAT, so maybe this case isn\u0027t a security problem. But there\u0027s still a race between multiple processes.\n\nBottom line: Secure creation of temporary files is a bit subtle, in particular if there\u0027s a possibility that one is using a world-writable directory like /tmp. So I think it\u0027s best to stick to the known-good patterns, including mkstemp and mkdtemp.",
      "parentUuid": "cd9793af_4275851e",
      "range": {
        "startLine": 27,
        "startChar": 36,
        "endLine": 27,
        "endChar": 62
      },
      "revId": "10eccb50b251f3e94fcb680446c10dd272fa1902",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "537bc074_7c68b097",
        "filename": "rtc_tools/video_file_writer_unittest.cc",
        "patchSetId": 1
      },
      "lineNbr": 27,
      "author": {
        "id": 7285
      },
      "writtenOn": "2019-03-15T15:15:18Z",
      "side": 1,
      "message": "Yes of course! I don\u0027t know why I thought GenerateTempFilename somehow reserved the name. Thanks for spelling it out. And you\u0027re right that the method is misleading. Going to remove it in a subsequent CL.",
      "parentUuid": "23b7294d_501b8d40",
      "range": {
        "startLine": 27,
        "startChar": 36,
        "endLine": 27,
        "endChar": 62
      },
      "revId": "10eccb50b251f3e94fcb680446c10dd272fa1902",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "67e40972_6a40ebe2",
        "filename": "rtc_tools/video_file_writer_unittest.cc",
        "patchSetId": 1
      },
      "lineNbr": 54,
      "author": {
        "id": 5087
      },
      "writtenOn": "2019-03-14T16:53:55Z",
      "side": 1,
      "message": "Why don\u0027t we always remove it?",
      "range": {
        "startLine": 54,
        "startChar": 4,
        "endLine": 54,
        "endChar": 28
      },
      "revId": "10eccb50b251f3e94fcb680446c10dd272fa1902",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "16cb88f7_45d726ea",
        "filename": "rtc_tools/video_file_writer_unittest.cc",
        "patchSetId": 1
      },
      "lineNbr": 54,
      "author": {
        "id": 7285
      },
      "writtenOn": "2019-03-14T17:18:10Z",
      "side": 1,
      "message": "Paranoid sanity check. I don\u0027t want to invoke RemoveDir with an empty path if SetUp() has failed.",
      "parentUuid": "67e40972_6a40ebe2",
      "range": {
        "startLine": 54,
        "startChar": 4,
        "endLine": 54,
        "endChar": 28
      },
      "revId": "10eccb50b251f3e94fcb680446c10dd272fa1902",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": false
    }
  ]
}