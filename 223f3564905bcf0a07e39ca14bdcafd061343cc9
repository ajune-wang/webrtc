{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "f5daf2ad_b4e0b3f2",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 18974
      },
      "writtenOn": "2022-11-17T08:18:12Z",
      "side": 1,
      "message": "There will be ~6700 times(for 3X3 call) and ~5800 times(for 1:1 call) of PostTask in 10 s for rtc_event_log before this CL event when logging doesn\u0027t start, which means this CL will recude PostTask by ~670 times/s(for 3X3 call) and ~580 times/s(for 1:1 call) when logging doesn\u0027t start.",
      "revId": "223f3564905bcf0a07e39ca14bdcafd061343cc9",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "142053f8_c92d6acd",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 5150
      },
      "writtenOn": "2022-11-17T14:12:08Z",
      "side": 1,
      "message": "Thanks for looking into this!\n\nHowever, I wonder if you\u0027ve measured the performance impact on something user visible, e.g. power? If so, could you share those results? (This CL removes unnecessary PostTask, but introduces extra locks which could cause contention, for example.)",
      "revId": "223f3564905bcf0a07e39ca14bdcafd061343cc9",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "25f30e04_2cd532d1",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 18974
      },
      "writtenOn": "2022-11-18T01:54:56Z",
      "side": 1,
      "message": "I have measured power effect on Intel ADL (ChromeOS):\nFor 3x3 call: Package power can be reduced from 3.13 w to 3.05 w, gaining 0.08 w(2.6%) power saving;\nFor 1:1 call: Package Power can be reduced from 2.55 w to 2.52 w, gaining 0.03 w(1.2%) power saving.",
      "parentUuid": "142053f8_c92d6acd",
      "revId": "223f3564905bcf0a07e39ca14bdcafd061343cc9",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "57a5d325_0a8d38a5",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 18974
      },
      "writtenOn": "2022-11-18T07:47:19Z",
      "side": 1,
      "message": "As for your concern about the use of locks:\n\nWhen logging starts – \nAlthough ’LogToMemory‘ and ’ScheduleOutput‘ both have the lock, they won’t be blocked for they are posted to a same task queue.\n\nWhen logging doesn’t start – \nFor there are only pop_front and push_back  main operations in ’LogToMemory‘ and ’LogToMemory‘ is a void function with no need for any return, which mean ’LogToMemory‘ will complete in a very short time and almost won’t lead to any block.\nAnd the original code use PostTask for ’LogToMemory‘, there is also a lock and operation of push in the original PostTasks, see:\nhttps://source.chromium.org/chromium/chromium/src/+/main:third_party/webrtc/rtc_base/task_queue_libevent.cc;l\u003d206\nhttps://source.chromium.org/chromium/chromium/src/+/main:third_party/webrtc/rtc_base/task_queue_stdlib.cc;l\u003d161\nhttps://source.chromium.org/chromium/chromium/src/+/main:third_party/webrtc/rtc_base/task_queue_win.cc;l\u003d221\nhttps://source.chromium.org/chromium/chromium/src/+/main:third_party/webrtc/rtc_base/thread.cc;l\u003d496\nhttps://source.chromium.org/chromium/chromium/src/+/main:third_party/webrtc/test/time_controller/simulated_task_queue.cc;l\u003d70\nhttps://source.chromium.org/chromium/chromium/src/+/main:base/task/sequence_manager/task_queue_impl.cc;drc\u003d603337a74bf04efd536b251a7f2b4eb44fe153a9;l\u003d422\nWe just move the lock in PostTask out to ‘LogToMemory’ and do the push operation.",
      "parentUuid": "25f30e04_2cd532d1",
      "revId": "223f3564905bcf0a07e39ca14bdcafd061343cc9",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e69a2c56_f7e89696",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 5150
      },
      "writtenOn": "2022-11-24T10:34:12Z",
      "side": 1,
      "message": "Thanks. A 2.6% power reduction seems well worth it.\n\nThe locks and atomics introduce some additional complexity though. For example,\nthere seems to be a bit of a race that might cause events to be dropped: Let\u0027s say that a new event is logged and and logging is not in progress according to the atomic check on line 143. Before the event can be written to memory, logging is started on another thread, which dumps the contents of the memory buffer to a file.\nThen the first event is added to the (now empty) memory buffer.\n\nThis could be fixed by taking the lock earlier, I think. However, I understand that Markus has a different proposal to solve the same problem. I suggest we wait a bit and compare the two approaches.",
      "parentUuid": "57a5d325_0a8d38a5",
      "revId": "223f3564905bcf0a07e39ca14bdcafd061343cc9",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6fb981f9_7b804954",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 9515
      },
      "writtenOn": "2022-11-25T18:18:02Z",
      "side": 1,
      "message": "For reference here\u0027s the other CL: https://webrtc-review.googlesource.com/c/src/+/265406. It removes PostTasks even when logging is on. I haven\u0027t landed it due to the low impact we measured earlier, but Xuanxi if you measure impact I think I\u0027m ready to change my mind on landing it.",
      "parentUuid": "e69a2c56_f7e89696",
      "revId": "223f3564905bcf0a07e39ca14bdcafd061343cc9",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7ac88d53_1c8c1b84",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 18974
      },
      "writtenOn": "2022-11-28T08:48:52Z",
      "side": 1,
      "message": "Thanks Björn. We will work on your concern about the possibility of the event drop.",
      "parentUuid": "6fb981f9_7b804954",
      "revId": "223f3564905bcf0a07e39ca14bdcafd061343cc9",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3991bce9_8a1a2b2e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 18974
      },
      "writtenOn": "2022-11-28T08:50:38Z",
      "side": 1,
      "message": "Thanks Markus. We will start to measure the power and PostTasks times impact of the CL: https://webrtc-review.googlesource.com/c/src/+/265406.",
      "parentUuid": "7ac88d53_1c8c1b84",
      "revId": "223f3564905bcf0a07e39ca14bdcafd061343cc9",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    }
  ]
}