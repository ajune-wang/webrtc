/*
 *  Copyright (c) 2018 The WebRTC project authors. All Rights Reserved.
 *
 *  Use of this source code is governed by a BSD-style license
 *  that can be found in the LICENSE file in the root of the source
 *  tree. An additional intellectual property rights grant can be found
 *  in the file PATENTS.  All contributing project authors may
 *  be found in the AUTHORS file in the root of the source tree.
 */

#include <array>

#include "common_audio/rnn_vad/common.h"
#include "common_audio/rnn_vad/features_extraction.h"
#include "common_audio/rnn_vad/rnn_vad_fft.h"
#include "common_audio/rnn_vad/sequence_buffer.h"
#include "common_audio/rnn_vad/test_utils.h"
#include "rtc_base/checks.h"
#include "test/fpe_observer.h"
#include "test/gtest.h"

namespace webrtc {
namespace test {

using rnn_vad::BiQuadFilter;
using rnn_vad::ComputeHalfVorbisWindow;
using rnn_vad::kHpfConfig48kHz;
using rnn_vad::RnnVadFft;
using rnn_vad::SequenceBuffer;

namespace {

// TODO(alessiob): Move to test_utils.cc/h.
void CheckFftResult(rtc::ArrayView<const float> expected_real,
                    rtc::ArrayView<const float> expected_imag,
                    rtc::ArrayView<const std::complex<float>> computed,
                    const float tolerance) {
  ASSERT_EQ(expected_real.size(), expected_imag.size());
  ASSERT_EQ(computed.size(), expected_real.size());
  for (size_t i = 0; i < computed.size(); ++i) {
    SCOPED_TRACE(i);
    // TODO(alessiob): EXPECT_FLOAT_EQ() fails, check why.
    EXPECT_NEAR(expected_real[i], computed[i].real(), tolerance);
    EXPECT_NEAR(expected_imag[i], computed[i].imag(), tolerance);
  }
}

static_assert((kFrameSize20ms48kHz & 1) == 0, "");
constexpr size_t kHalfVorbisWinSize20ms48kHz = kFrameSize20ms48kHz / 2;
constexpr std::array<float, kHalfVorbisWinSize20ms48kHz>
    kHalfVorbisWin20ms48kHz = {0.0000042054916775668971240520477294921875f,
                               0.00003784915315918624401092529296875f,
                               0.000105135040939785540103912353515625f,
                               0.000206060256459750235080718994140625f,
                               0.00034062049235217273235321044921875f,
                               0.0005088099860586225986480712890625f,
                               0.00071062147617340087890625f,
                               0.0009460463188588619232177734375f,
                               0.00121507444418966770172119140625f,
                               0.00151769421063363552093505859375f,
                               0.00185389257967472076416015625f,
                               0.0022236551158130168914794921875f,
                               0.00262696598656475543975830078125f,
                               0.00306380726397037506103515625f,
                               0.003534160554409027099609375f,
                               0.004038005135953426361083984375f,
                               0.004575319588184356689453125f,
                               0.005146079696714878082275390625f,
                               0.005750261247158050537109375f,
                               0.006387837231159210205078125f,
                               0.0070587801747024059295654296875f,
                               0.0077630602754652500152587890625f,
                               0.0085006467998027801513671875f,
                               0.009271507151424884796142578125f,
                               0.010075606405735015869140625f,
                               0.01091291010379791259765625f,
                               0.0117833800613880157470703125f,
                               0.01268697716295719146728515625f,
                               0.013623661361634731292724609375f,
                               0.014593389816582202911376953125f,
                               0.01559611968696117401123046875f,
                               0.016631804406642913818359375f,
                               0.01770039834082126617431640625f,
                               0.01880185306072235107421875f,
                               0.0199361145496368408203125f,
                               0.02110313437879085540771484375f,
                               0.02230285666882991790771484375f,
                               0.0235352255403995513916015625f,
                               0.0248001851141452789306640625f,
                               0.0260976739227771759033203125f,
                               0.02742763422429561614990234375f,
                               0.02878999896347522735595703125f,
                               0.030184708535671234130859375f,
                               0.0316116921603679656982421875f,
                               0.033070884644985198974609375f,
                               0.0345622114837169647216796875f,
                               0.036085605621337890625f,
                               0.037640988826751708984375f,
                               0.0392282903194427490234375f,
                               0.040847428143024444580078125f,
                               0.0424983240664005279541015625f,
                               0.044180892407894134521484375f,
                               0.04589505493640899658203125f,
                               0.04764072597026824951171875f,
                               0.0494178123772144317626953125f,
                               0.0512262284755706787109375f,
                               0.0530658774077892303466796875f,
                               0.0549366734921932220458984375f,
                               0.056838512420654296875f,
                               0.0587713010609149932861328125f,
                               0.060734935104846954345703125f,
                               0.06272931396961212158203125f,
                               0.064754329621791839599609375f,
                               0.066809885203838348388671875f,
                               0.068895854055881500244140625f,
                               0.07101213932037353515625f,
                               0.073158629238605499267578125f,
                               0.07533518970012664794921875f,
                               0.077541716396808624267578125f,
                               0.07977809011936187744140625f,
                               0.082044184207916259765625f,
                               0.084339864552021026611328125f,
                               0.086665011942386627197265625f,
                               0.089019499719142913818359375f,
                               0.091403193771839141845703125f,
                               0.0938159525394439697265625f,
                               0.09625764191150665283203125f,
                               0.098728120326995849609375f,
                               0.101227246224880218505859375f,
                               0.10375487804412841796875f,
                               0.106310866773128509521484375f,
                               0.1088950634002685546875f,
                               0.11150731146335601806640625f,
                               0.1141474545001983642578125f,
                               0.11681534349918365478515625f,
                               0.119510807096958160400390625f,
                               0.122233688831329345703125f,
                               0.12498383224010467529296875f,
                               0.12776105105876922607421875f,
                               0.13056518137454986572265625f,
                               0.1333960592746734619140625f,
                               0.1362535059452056884765625f,
                               0.139137327671051025390625f,
                               0.14204736053943634033203125f,
                               0.14498341083526611328125f,
                               0.14794528484344482421875f,
                               0.1509328186511993408203125f,
                               0.15394580364227294921875f,
                               0.156984031200408935546875f,
                               0.16004733741283416748046875f,
                               0.16313548386096954345703125f,
                               0.16624830663204193115234375f,
                               0.16938556730747222900390625f,
                               0.1725470721721649169921875f,
                               0.17573259770870208740234375f,
                               0.17894195020198822021484375f,
                               0.18217490613460540771484375f,
                               0.1854312419891357421875f,
                               0.18871073424816131591796875f,
                               0.19201315939426422119140625f,
                               0.19533829391002655029296875f,
                               0.19868589937686920166015625f,
                               0.202055752277374267578125f,
                               0.20544759929180145263671875f,
                               0.20886123180389404296875f,
                               0.21229638159275054931640625f,
                               0.2157528102397918701171875f,
                               0.21923027932643890380859375f,
                               0.2227285206317901611328125f,
                               0.226247310638427734375f,
                               0.22978638112545013427734375f,
                               0.23334546387195587158203125f,
                               0.23692430555820465087890625f,
                               0.2405226528644561767578125f,
                               0.2441402375698089599609375f,
                               0.2477767765522003173828125f,
                               0.2514320313930511474609375f,
                               0.255105674266815185546875f,
                               0.258797466754913330078125f,
                               0.262507140636444091796875f,
                               0.26623439788818359375f,
                               0.2699789702892303466796875f,
                               0.2737405598163604736328125f,
                               0.27751886844635009765625f,
                               0.281313598155975341796875f,
                               0.285124480724334716796875f,
                               0.288951218128204345703125f,
                               0.2927935123443603515625f,
                               0.296651065349578857421875f,
                               0.3005235493183135986328125f,
                               0.3044106960296630859375f,
                               0.3083121776580810546875f,
                               0.312227666378021240234375f,
                               0.3161568939685821533203125f,
                               0.3200995028018951416015625f,
                               0.3240552246570587158203125f,
                               0.3280237019062042236328125f,
                               0.3320046365261077880859375f,
                               0.33599770069122314453125f,
                               0.3400025665760040283203125f,
                               0.3440189063549041748046875f,
                               0.3480463922023773193359375f,
                               0.3520847260951995849609375f,
                               0.356133520603179931640625f,
                               0.3601925075054168701171875f,
                               0.3642612993717193603515625f,
                               0.368339598178863525390625f,
                               0.3724270164966583251953125f,
                               0.3765232861042022705078125f,
                               0.38062798976898193359375f,
                               0.3847408592700958251953125f,
                               0.388861477375030517578125f,
                               0.392989575862884521484375f,
                               0.3971247375011444091796875f,
                               0.4012666642665863037109375f,
                               0.4054149687290191650390625f,
                               0.409569323062896728515625f,
                               0.4137293994426727294921875f,
                               0.417894780635833740234375f,
                               0.422065198421478271484375f,
                               0.4262402355670928955078125f,
                               0.4304195344448089599609375f,
                               0.4346027672290802001953125f,
                               0.4387896060943603515625f,
                               0.4429796040058135986328125f,
                               0.4471724927425384521484375f,
                               0.4513678848743438720703125f,
                               0.455565392971038818359375f,
                               0.4597646892070770263671875f,
                               0.46396541595458984375f,
                               0.46816718578338623046875f,
                               0.472369670867919921875f,
                               0.4765724837779998779296875f,
                               0.4807752668857574462890625f,
                               0.484977662563323974609375f,
                               0.4891793429851531982421875f,
                               0.493379890918731689453125f,
                               0.4975790083408355712890625f,
                               0.501776278018951416015625f,
                               0.505971372127532958984375f,
                               0.51016390323638916015625f,
                               0.514353573322296142578125f,
                               0.518539905548095703125f,
                               0.522722721099853515625f,
                               0.5269014835357666015625f,
                               0.531075954437255859375f,
                               0.535245716571807861328125f,
                               0.539410412311553955078125f,
                               0.543569743633270263671875f,
                               0.547723293304443359375f,
                               0.551870763301849365234375f,
                               0.556011736392974853515625f,
                               0.56014597415924072265625f,
                               0.56427299976348876953125f,
                               0.5683925151824951171875f,
                               0.572504222393035888671875f,
                               0.57660770416259765625f,
                               0.58070266246795654296875f,
                               0.584788739681243896484375f,
                               0.58886563777923583984375f,
                               0.5929329395294189453125f,
                               0.5969903469085693359375f,
                               0.601037502288818359375f,
                               0.6050741672515869140625f,
                               0.609099924564361572265625f,
                               0.613114416599273681640625f,
                               0.617117404937744140625f,
                               0.621108531951904296875f,
                               0.625087440013885498046875f,
                               0.6290538311004638671875f,
                               0.63300740718841552734375f,
                               0.6369478702545166015625f,
                               0.6408748626708984375f,
                               0.644788086414337158203125f,
                               0.64868724346160888671875f,
                               0.65257203578948974609375f,
                               0.656442165374755859375f,
                               0.660297334194183349609375f,
                               0.664137184619903564453125f,
                               0.667961537837982177734375f,
                               0.67176997661590576171875f,
                               0.675562322139739990234375f,
                               0.679338276386260986328125f,
                               0.68309748172760009765625f,
                               0.686839759349822998046875f,
                               0.69056475162506103515625f,
                               0.6942722797393798828125f,
                               0.697961986064910888671875f,
                               0.7016336917877197265625f,
                               0.705287039279937744140625f,
                               0.708921849727630615234375f,
                               0.71253788471221923828125f,
                               0.7161347866058349609375f,
                               0.719712436199188232421875f,
                               0.72327053546905517578125f,
                               0.72680890560150146484375f,
                               0.730327188968658447265625f,
                               0.733825266361236572265625f,
                               0.73730289936065673828125f,
                               0.740759789943695068359375f,
                               0.74419581890106201171875f,
                               0.74761068820953369140625f,
                               0.751004278659820556640625f,
                               0.754376351833343505859375f,
                               0.7577266693115234375f,
                               0.76105511188507080078125f,
                               0.76436138153076171875f,
                               0.767645359039306640625f,
                               0.770906865596771240234375f,
                               0.77414572238922119140625f,
                               0.77736175060272216796875f,
                               0.78055477142333984375f,
                               0.783724606037139892578125f,
                               0.78687107563018798828125f,
                               0.78999412059783935546875f,
                               0.793093502521514892578125f,
                               0.796169102191925048828125f,
                               0.7992208003997802734375f,
                               0.802248418331146240234375f,
                               0.8052518367767333984375f,
                               0.808230936527252197265625f,
                               0.8111855983734130859375f,
                               0.814115703105926513671875f,
                               0.8170211315155029296875f,
                               0.819901764392852783203125f,
                               0.822757542133331298828125f,
                               0.825588285923004150390625f,
                               0.8283939361572265625f,
                               0.831174433231353759765625f,
                               0.83392965793609619140625f,
                               0.83665955066680908203125f,
                               0.839363992214202880859375f,
                               0.842042982578277587890625f,
                               0.84469640254974365234375f,
                               0.84732425212860107421875f,
                               0.84992635250091552734375f,
                               0.852502763271331787109375f,
                               0.855053424835205078125f,
                               0.857578217983245849609375f,
                               0.860077202320098876953125f,
                               0.862550258636474609375f,
                               0.864997446537017822265625f,
                               0.86741864681243896484375f,
                               0.8698139190673828125f,
                               0.87218320369720458984375f,
                               0.874526560306549072265625f,
                               0.876843869686126708984375f,
                               0.879135191440582275390625f,
                               0.881400525569915771484375f,
                               0.88363993167877197265625f,
                               0.885853290557861328125f,
                               0.8880407810211181640625f,
                               0.890202343463897705078125f,
                               0.892337977886199951171875f,
                               0.894447743892669677734375f,
                               0.89653170108795166015625f,
                               0.8985898494720458984375f,
                               0.90062224864959716796875f,
                               0.902628958225250244140625f,
                               0.90461003780364990234375f,
                               0.906565487384796142578125f,
                               0.908495426177978515625f,
                               0.910399913787841796875f,
                               0.91227900981903076171875f,
                               0.914132773876190185546875f,
                               0.91596126556396484375f,
                               0.9177646636962890625f,
                               0.91954290866851806640625f,
                               0.92129623889923095703125f,
                               0.923024654388427734375f,
                               0.924728214740753173828125f,
                               0.926407158374786376953125f,
                               0.92806148529052734375f,
                               0.929691314697265625f,
                               0.931296765804290771484375f,
                               0.932878017425537109375f,
                               0.934435069561004638671875f,
                               0.9359681606292724609375f,
                               0.937477290630340576171875f,
                               0.9389626979827880859375f,
                               0.940424501895904541015625f,
                               0.9418628215789794921875f,
                               0.943277776241302490234375f,
                               0.9446694850921630859375f,
                               0.946038186550140380859375f,
                               0.947383940219879150390625f,
                               0.948706924915313720703125f,
                               0.95000731945037841796875f,
                               0.95128524303436279296875f,
                               0.952540874481201171875f,
                               0.953774392604827880859375f,
                               0.954985916614532470703125f,
                               0.95617568492889404296875f,
                               0.9573438167572021484375f,
                               0.95849049091339111328125f,
                               0.959615886211395263671875f,
                               0.96072018146514892578125f,
                               0.96180355548858642578125f,
                               0.962866246700286865234375f,
                               0.96390831470489501953125f,
                               0.964930057525634765625f,
                               0.965931594371795654296875f,
                               0.966913163661956787109375f,
                               0.967874944210052490234375f,
                               0.968817174434661865234375f,
                               0.9697399139404296875f,
                               0.970643520355224609375f,
                               0.971528112888336181640625f,
                               0.97239387035369873046875f,
                               0.9732410907745361328125f,
                               0.974069893360137939453125f,
                               0.974880516529083251953125f,
                               0.975673139095306396484375f,
                               0.976447999477386474609375f,
                               0.977205336093902587890625f,
                               0.977945268154144287109375f,
                               0.97866809368133544921875f,
                               0.97937405109405517578125f,
                               0.9800631999969482421875f,
                               0.98073589801788330078125f,
                               0.981392323970794677734375f,
                               0.982032716274261474609375f,
                               0.982657253742218017578125f,
                               0.9832661151885986328125f,
                               0.98385965824127197265625f,
                               0.9844379425048828125f,
                               0.985001266002655029296875f,
                               0.985549867153167724609375f,
                               0.986083924770355224609375f,
                               0.986603677272796630859375f,
                               0.987109363079071044921875f,
                               0.98760116100311279296875f,
                               0.9880793094635009765625f,
                               0.988544046878814697265625f,
                               0.98899555206298828125f,
                               0.989434063434600830078125f,
                               0.989859879016876220703125f,
                               0.99027311801910400390625f,
                               0.99067401885986328125f,
                               0.991062819957733154296875f,
                               0.99143970012664794921875f,
                               0.99180495738983154296875f,
                               0.99215877056121826171875f,
                               0.992501318454742431640625f,
                               0.9928328990936279296875f,
                               0.993153631687164306640625f,
                               0.993463814258575439453125f,
                               0.993763625621795654296875f,
                               0.99405324459075927734375f,
                               0.994332969188690185546875f,
                               0.9946029186248779296875f,
                               0.994863331317901611328125f,
                               0.99511444568634033203125f,
                               0.99535644054412841796875f,
                               0.995589554309844970703125f,
                               0.99581396579742431640625f,
                               0.99602985382080078125f,
                               0.9962375164031982421875f,
                               0.99643707275390625f,
                               0.996628701686859130859375f,
                               0.996812641620635986328125f,
                               0.99698913097381591796875f,
                               0.9971582889556884765625f,
                               0.99732029438018798828125f,
                               0.997475445270538330078125f,
                               0.997623860836029052734375f,
                               0.997765719890594482421875f,
                               0.997901260852813720703125f,
                               0.998030602931976318359375f,
                               0.9981539249420166015625f,
                               0.998271465301513671875f,
                               0.99838340282440185546875f,
                               0.998489856719970703125f,
                               0.998591005802154541015625f,
                               0.998687088489532470703125f,
                               0.998778164386749267578125f,
                               0.99886453151702880859375f,
                               0.998946249485015869140625f,
                               0.99902355670928955078125f,
                               0.99909651279449462890625f,
                               0.99916541576385498046875f,
                               0.99923026561737060546875f,
                               0.99929130077362060546875f,
                               0.999348700046539306640625f,
                               0.999402523040771484375f,
                               0.999453008174896240234375f,
                               0.999500215053558349609375f,
                               0.999544322490692138671875f,
                               0.99958550930023193359375f,
                               0.999623775482177734375f,
                               0.99965941905975341796875f,
                               0.999692440032958984375f,
                               0.999723017215728759765625f,
                               0.999751269817352294921875f,
                               0.999777317047119140625f,
                               0.99980127811431884765625f,
                               0.99982321262359619140625f,
                               0.9998433589935302734375f,
                               0.999861657619476318359375f,
                               0.999878346920013427734375f,
                               0.999893486499786376953125f,
                               0.999907195568084716796875f,
                               0.99991953372955322265625f,
                               0.999930560588836669921875f,
                               0.999940454959869384765625f,
                               0.9999492168426513671875f,
                               0.999957025051116943359375f,
                               0.99996387958526611328125f,
                               0.99996984004974365234375f,
                               0.99997508525848388671875f,
                               0.99997961521148681640625f,
                               0.999983489513397216796875f,
                               0.99998676776885986328125f,
                               0.99998950958251953125f,
                               0.999991834163665771484375f,
                               0.999993741512298583984375f,
                               0.999995291233062744140625f,
                               0.99999654293060302734375f,
                               0.999997556209564208984375f,
                               0.999998271465301513671875f,
                               0.999998867511749267578125f,
                               0.9999992847442626953125f,
                               0.999999523162841796875f,
                               0.9999997615814208984375f,
                               0.99999988079071044921875f,
                               0.999999940395355224609375f,
                               1.f,
                               1.f,
                               1.f,
                               1.f};

}  // namespace

// TODO(alessiob): Don't include this test.
TEST(RnnVadTest, AnalysisWindowBitExactness) {
  auto computed_analysis_win =
      ComputeHalfVorbisWindow(kHalfVorbisWinSize20ms48kHz);
  EXPECT_EQ(kHalfVorbisWin20ms48kHz.size(), computed_analysis_win.size());
  for (size_t i = 0; i < kHalfVorbisWin20ms48kHz.size(); ++i)
    EXPECT_FLOAT_EQ(kHalfVorbisWin20ms48kHz[i], computed_analysis_win[i]);
}

TEST(RnnVadTest, ComputeForwardFftBitExactness) {
  // PCM samples reader and buffers.
  auto samples_reader = CreatePreprocessedSamplesReader();
  const size_t num_frames = samples_reader.second;
  std::array<float, kFrameSize10ms48kHz> samples;
  rtc::ArrayView<float, kFrameSize10ms48kHz> samples_view(samples.data(),
                                                          kFrameSize10ms48kHz);
  // FFT ground truth reader and buffers.
  auto fft_coeffs_reader = CreateFftCoeffsReader(true);
  ASSERT_EQ(num_frames, fft_coeffs_reader.second);
  std::array<float, kFftNumCoeffs20ms48kHz> fft_coeffs_real;
  std::array<float, kFftNumCoeffs20ms48kHz> fft_coeffs_imag;
  // Init pipeline.
  SequenceBuffer<float, kFrameSize20ms48kHz, kFrameSize10ms48kHz> seq_buf(0.f);
  auto seq_buf_view = seq_buf.GetBufferView();
  RnnVadFft fft(kFrameSize20ms48kHz);
  std::array<std::complex<float>, kFrameSize20ms48kHz> computed_fft_coeffs;

  // Process frames.
  {
    FloatingPointExceptionObserver fpe_observer;

    for (size_t i = 0; i < num_frames; ++i) {
      SCOPED_TRACE(i);
      // Read 10 ms audio frame and corresponding FFT coefficients.
      samples_reader.first->ReadChunk(samples_view);
      fft_coeffs_reader.first->ReadChunk(
          {fft_coeffs_real.data(), fft_coeffs_real.size()});
      fft_coeffs_reader.first->ReadChunk(
          {fft_coeffs_imag.data(), fft_coeffs_imag.size()});
      // Run pipeline and check output.
      seq_buf.Push(samples_view);
      fft.ForwardFft(seq_buf_view, {computed_fft_coeffs});
      CheckFftResult({fft_coeffs_real}, {fft_coeffs_imag},
                     {computed_fft_coeffs.data(), kFftNumCoeffs20ms48kHz},
                     1e-4f);
    }
  }
}

}  // namespace test
}  // namespace webrtc
