{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "84a21db4_b6e8a737",
        "filename": "pc/sdp_offer_answer.cc",
        "patchSetId": 12
      },
      "lineNbr": 774,
      "author": {
        "id": 5142
      },
      "writtenOn": "2022-01-10T11:34:59Z",
      "side": 1,
      "message": "OnSetRemoteDescriptionComplete() should be called before operations_chain_callback_() (see https://webrtc-review.googlesource.com/c/src/+/244980/12/pc/sdp_offer_answer.cc#b1534).\n\nBy calling operations_chain_callback_() you are unblocking the operations chain from running the next operation, so if this happens prior to OnSetRemoteDescriptionComplete() then by the time OnSetRemoteDescriptionComplete() is called other operations may already have executed that were also queued on the chain. E.g. if you call SLD and SRD without waiting for operations to complete in-between.\n\nIt\u0027s an edge-case but matters to Chrome. For example, when OnSetRemoteDescriptionComplete() happens Chrome will copy various peer connection states and expose that information to JavaScript by updating JS objects. E.g. signalingState and transceiver states. If OnSetRemoteDescriptionComplete() is called first, then we always copy the correct states, but if OnSetRemoteDescriptionComplete() is called second then we could end up copying the result of multiple queued operations rather than the one for which the promise resolved.\n\nThis WPT should over the issue I think:\nhttps://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/web_tests/external/wpt/webrtc/RTCPeerConnection-SLD-SRD-timing.https.html",
      "revId": "32b05ab85c14498da548d136c30da6624d0224b0",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "f3585353_84fe7264",
        "filename": "pc/sdp_offer_answer.cc",
        "patchSetId": 12
      },
      "lineNbr": 774,
      "author": {
        "id": 5508
      },
      "writtenOn": "2022-01-11T10:17:46Z",
      "side": 1,
      "message": "Done. Thanks for catching.",
      "parentUuid": "84a21db4_b6e8a737",
      "revId": "32b05ab85c14498da548d136c30da6624d0224b0",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4c335df8_5a3ed2ac",
        "filename": "pc/sdp_offer_answer.cc",
        "patchSetId": 12
      },
      "lineNbr": 850,
      "author": {
        "id": 5142
      },
      "writtenOn": "2022-01-10T11:34:59Z",
      "side": 1,
      "message": "Awesome! But see chat, I think there may be an internal dependency that needs to be updated before async stuff can happen (e.g. a CHECK that the operation is immediately complete).",
      "revId": "32b05ab85c14498da548d136c30da6624d0224b0",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "62663b93_46162809",
        "filename": "pc/sdp_offer_answer.cc",
        "patchSetId": 12
      },
      "lineNbr": 850,
      "author": {
        "id": 5508
      },
      "writtenOn": "2022-01-11T10:17:46Z",
      "side": 1,
      "message": "Thanks, looking into it. I think that even before we can make DoSetRemoteDescription fully async, breaking things up into smaller chunks, will allow us to group together operations that need to run on the same threads and do at most one Invoke() per thread instead of several as we do today.",
      "parentUuid": "4c335df8_5a3ed2ac",
      "revId": "32b05ab85c14498da548d136c30da6624d0224b0",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "bcc4d8f9_99a35e6c",
        "filename": "pc/sdp_offer_answer.cc",
        "patchSetId": 12
      },
      "lineNbr": 850,
      "author": {
        "id": 5142
      },
      "writtenOn": "2022-01-11T11:04:07Z",
      "side": 1,
      "message": "Totally agree, just a heads up. I think we should start landing these changes.\n\nAnother heads up is to also test on https://webrtc.github.io/samples/src/content/peerconnection/negotiate-timing/ when making significant changes to number of invokes to make sure we don\u0027t block packet delivery for too long causing glitches. Hopefully we\u0027re not as sensitive to that anymore but regressions to that is something that tests don\u0027t catch at the moment.",
      "parentUuid": "62663b93_46162809",
      "revId": "32b05ab85c14498da548d136c30da6624d0224b0",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "45b30565_86e750c4",
        "filename": "pc/sdp_offer_answer.cc",
        "patchSetId": 12
      },
      "lineNbr": 2299,
      "author": {
        "id": 5142
      },
      "writtenOn": "2022-01-10T11:34:59Z",
      "side": 1,
      "message": "nit/optional: We are calling various sub-steps here. Would it make sense to move this into a RemoteDescriptionOperation function for all steps and make the sub-steps private?",
      "revId": "32b05ab85c14498da548d136c30da6624d0224b0",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d70f3a84_8f26d21f",
        "filename": "pc/sdp_offer_answer.cc",
        "patchSetId": 12
      },
      "lineNbr": 2299,
      "author": {
        "id": 5508
      },
      "writtenOn": "2022-01-11T10:17:46Z",
      "side": 1,
      "message": "Eventually yes. In order to reduce chances of running into long debug sessions and series of reverts, I\u0027m choosing to keep the \"recipe\" in the same place it used to be and just move the individual sub steps into their own functions. Down the line I hope to make this more clearly laid out and separate from the SdpOfferAnswerHandler class.",
      "parentUuid": "45b30565_86e750c4",
      "revId": "32b05ab85c14498da548d136c30da6624d0224b0",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "f6f219db_b6bac4b2",
        "filename": "pc/sdp_offer_answer.cc",
        "patchSetId": 12
      },
      "lineNbr": 2299,
      "author": {
        "id": 5142
      },
      "writtenOn": "2022-01-11T11:04:07Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "d70f3a84_8f26d21f",
      "revId": "32b05ab85c14498da548d136c30da6624d0224b0",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f15b49f3_581c30a3",
        "filename": "pc/sdp_offer_answer.cc",
        "patchSetId": 12
      },
      "lineNbr": 2326,
      "author": {
        "id": 5142
      },
      "writtenOn": "2022-01-10T11:34:59Z",
      "side": 1,
      "message": "operation.reset() implicitly invokes both operations_chain_callback_() and OnSetRemoteDescriptionComplete() earlier than what happened previously, I think this will cause problems (see other comment).",
      "revId": "32b05ab85c14498da548d136c30da6624d0224b0",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c1688b6a_83144705",
        "filename": "pc/sdp_offer_answer.cc",
        "patchSetId": 12
      },
      "lineNbr": 2326,
      "author": {
        "id": 5508
      },
      "writtenOn": "2022-01-11T10:17:46Z",
      "side": 1,
      "message": "Thanks. Addressed the order issue above and changed this to explicitly notify the observer here.",
      "parentUuid": "f15b49f3_581c30a3",
      "revId": "32b05ab85c14498da548d136c30da6624d0224b0",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "7609e66d_cb82527a",
        "filename": "pc/sdp_offer_answer.cc",
        "patchSetId": 12
      },
      "lineNbr": 2326,
      "author": {
        "id": 5142
      },
      "writtenOn": "2022-01-12T08:30:52Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "c1688b6a_83144705",
      "revId": "32b05ab85c14498da548d136c30da6624d0224b0",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9c0c2401_d472aa2f",
        "filename": "pc/sdp_offer_answer.cc",
        "patchSetId": 12
      },
      "lineNbr": 2334,
      "author": {
        "id": 5142
      },
      "writtenOn": "2022-01-10T11:34:59Z",
      "side": 1,
      "message": "Removing stopped transceivers also need to be considered part of the SRD operation, otherwise Chrome might surface transceiver states prematurely resulting in stopped transceivers not disappearing in JavaScript. It might cause this WPT to fail? https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/web_tests/external/wpt/webrtc/RTCRtpTransceiver-stop.html;l\u003d136",
      "revId": "32b05ab85c14498da548d136c30da6624d0224b0",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a59413aa_9709e11f",
        "filename": "pc/sdp_offer_answer.cc",
        "patchSetId": 12
      },
      "lineNbr": 2334,
      "author": {
        "id": 5508
      },
      "writtenOn": "2022-01-11T10:17:46Z",
      "side": 1,
      "message": "it is still a part of SRD (see function call above) - or am I missing your point?",
      "parentUuid": "9c0c2401_d472aa2f",
      "revId": "32b05ab85c14498da548d136c30da6624d0224b0",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8ae00eae_5cf346bb",
        "filename": "pc/sdp_offer_answer.cc",
        "patchSetId": 12
      },
      "lineNbr": 2334,
      "author": {
        "id": 5142
      },
      "writtenOn": "2022-01-11T11:04:07Z",
      "side": 1,
      "message": "I am referring to the fact that SetRemoteDescriptionPostProcess() is changing states (e.g. removing transceivers) after SignalCompletion() has already happened. Remember that that peer connection states (such as which transceivers exists) are copied on SignalCompletion(). So the observer won\u0027t have access to the final states when it is invoked.\n\nAnother concern I had in the previous PS was if the operation chain callback was invoked prior to SetRemoteDescriptionPostProcess() having executed, but this has now been addressed and is not a concern anymore.",
      "parentUuid": "a59413aa_9709e11f",
      "revId": "32b05ab85c14498da548d136c30da6624d0224b0",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "5a6ea86d_72c5dd8a",
        "filename": "pc/sdp_offer_answer.cc",
        "patchSetId": 12
      },
      "lineNbr": 2334,
      "author": {
        "id": 5508
      },
      "writtenOn": "2022-01-11T19:00:03Z",
      "side": 1,
      "message": "Ah I see. I\u0027ve moved the call to RemoveStoppedTransceivers() up to before the completion notification now.",
      "parentUuid": "8ae00eae_5cf346bb",
      "revId": "32b05ab85c14498da548d136c30da6624d0224b0",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    }
  ]
}