{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "5fa2ba05_9a982150",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 7
      },
      "lineNbr": 0,
      "author": {
        "id": 5234
      },
      "writtenOn": "2022-03-09T13:28:35Z",
      "side": 1,
      "message": "There\u0027s a use-after-free, apparently on windows only. From the stack traces, I see this problem:\n\nThe test (I\u0027m looking at the failure of PeerConnectionIntegrationTest/PeerConnectionIntegrationTest.IceTransportFactoryUsedForConnections/3, see https://chromium-swarm.appspot.com/task?id\u003d5987999a2fe6f410) is finished, and the network thread created for the test is destroyed.\n\nControl gets to TestMainImpl::OnTestEnd (in test/test_main_lib.cc). This class has wrapped the main thread (comments indicate that maybe that could be deleted, now that automatic thread wrapping is gone). It calls thread_-\u003eQuit() followed by thread_-\u003eRun(). The latter finds a message that needs processing, and calls  FakeRTCCertificateGenerator::OnMessage.\n\nVia some other method calls, this gets to webrtc::JsepTransportController::SetLocalCertificate, which tries to Invoke to the network thread. But the network thread no longer exists. Which results in a use-after-free.\n\n",
      "revId": "5f06a74c8e57af89888e360f09e1720298f9e274",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "c1efa6d0_b980179a",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 7
      },
      "lineNbr": 0,
      "author": {
        "id": 5234
      },
      "writtenOn": "2022-03-16T14:13:14Z",
      "side": 1,
      "message": "I tried adding an rtc::AutoThread, in PeerConnectionIntegrationBaseTest, but that just made more tests fail.\n\nIt appears the problem is the test class FakeRTCCertificateGenerator; its GenerateCertificateAsync posts messages to rtc::Thread::Current(), and it seems these messages are not always handled before tests concludes. The class inherits rtc::MessageHandlerAutoCleanup though. So not sure which objects are still alive at the time of the OnMessage call. Maybe all these objects are kept alive via the scoped_refptr\u003cRTCCertificateGeneratorCallback\u003e, until we get to JsepTransportController, which holds a raw pointer to the network thread, and that thread no longer exists. \n\nUnclear why the FakeRTCCertificateGenerator is still alive, though, it\u0027s not refcounted, and not clear to me where it is owned, after being injected via  webrtc::PeerConnectionDependencies.\n\nThe callback class is refcounted, with a single implementation WebRtcCertificateGeneratorCallback. It contains some sigslots, connected like\n\n    callback-\u003eSignalCertificateReady.connect(\n        this, \u0026WebRtcSessionDescriptionFactory::SetCertificate);",
      "parentUuid": "5fa2ba05_9a982150",
      "revId": "5f06a74c8e57af89888e360f09e1720298f9e274",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "bedcda20_73f28b3f",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 7
      },
      "lineNbr": 0,
      "author": {
        "id": 5234
      },
      "writtenOn": "2022-03-16T14:17:12Z",
      "side": 1,
      "message": "For the record, these are the backtraces I\u0027m looking at:\n```\n\u003d\u003d7644\u003d\u003dERROR: AddressSanitizer: heap-use-after-free on address 0x129ae2b72040 at pc 0x7ff6a428ae1a bp 0x00e4c275ec40 sp 0x00e4c275ec88\nREAD of size 8 at 0x129ae2b72040 thread T0\n    #0 0x7ff6a428ae19 in rtc::Thread::InvokeInternal(class rtc::Location const \u0026, class rtc::FunctionView\u003c(void)\u003e) C:\\b\\s\\w\\ir\\cache\\builder\\src\\rtc_base\\thread.cc:1007:3\n    #1 0x7ff6a41a93f1 in rtc::Thread::Invoke C:\\b\\s\\w\\ir\\cache\\builder\\src\\rtc_base\\thread.h:393\n    #2 0x7ff6a41a93f1 in webrtc::JsepTransportController::SetLocalCertificate(class rtc::scoped_refptr\u003cclass rtc::RTCCertificate\u003e const \u0026) C:\\b\\s\\w\\ir\\cache\\builder\\src\\pc\\jsep_transport_controller.cc:217:29\n    #3 0x7ff6a399c21c in std::__1::__function::__policy_func\u003cvoid (const rtc::scoped_refptr\u003crtc::RTCCertificate\u003e \u0026)\u003e::operator() C:\\b\\s\\w\\ir\\cache\\builder\\src\\buildtools\\third_party\\libc++\\trunk\\include\\functional:2228\n    #4 0x7ff6a399c21c in std::__1::function\u003cvoid (const rtc::scoped_refptr\u003crtc::RTCCertificate\u003e \u0026)\u003e::operator() C:\\b\\s\\w\\ir\\cache\\builder\\src\\buildtools\\third_party\\libc++\\trunk\\include\\functional:2567\n    #5 0x7ff6a399c21c in webrtc::WebRtcSessionDescriptionFactory::SetCertificate(class rtc::scoped_refptr\u003cclass rtc::RTCCertificate\u003e const \u0026) C:\\b\\s\\w\\ir\\cache\\builder\\src\\pc\\webrtc_session_description_factory.cc:493:3\n    #6 0x7ff6a399a563 in sigslot::_opaque_connection::emit C:\\b\\s\\w\\ir\\cache\\builder\\src\\rtc_base\\third_party\\sigslot\\sigslot.h:331\n    #7 0x7ff6a399a563 in sigslot::signal_with_thread_policy\u003csigslot::single_threaded,const rtc::scoped_refptr\u003crtc::RTCCertificate\u003e \u0026\u003e::emit C:\\b\\s\\w\\ir\\cache\\builder\\src\\rtc_base\\third_party\\sigslot\\sigslot.h:563\n    #8 0x7ff6a399a563 in sigslot::signal_with_thread_policy\u003csigslot::single_threaded,const rtc::scoped_refptr\u003crtc::RTCCertificate\u003e \u0026\u003e::operator() C:\\b\\s\\w\\ir\\cache\\builder\\src\\rtc_base\\third_party\\sigslot\\sigslot.h:570\n    #9 0x7ff6a399a563 in webrtc::WebRtcCertificateGeneratorCallback::OnSuccess(class rtc::scoped_refptr\u003cclass rtc::RTCCertificate\u003e const \u0026) C:\\b\\s\\w\\ir\\cache\\builder\\src\\pc\\webrtc_session_description_factory.cc:95:3\n    #10 0x7ff6a29aefbc in FakeRTCCertificateGenerator::OnMessage(struct rtc::Message *) C:\\b\\s\\w\\ir\\cache\\builder\\src\\pc\\test\\fake_rtc_certificate_generator.h:226:19\n    #11 0x7ff6a4289337 in rtc::Thread::Dispatch(struct rtc::Message *) C:\\b\\s\\w\\ir\\cache\\builder\\src\\rtc_base\\thread.cc:700:19\n    #12 0x7ff6a4284d44 in rtc::Thread::ProcessMessages(int) C:\\b\\s\\w\\ir\\cache\\builder\\src\\rtc_base\\thread.cc:1144:5\n    #13 0x7ff6a40b3849 in webrtc::`anonymous namespace\u0027::TestMainImpl::TestListener::OnTestEnd C:\\b\\s\\w\\ir\\cache\\builder\\src\\test\\test_main_lib.cc:152:18\n    #14 0x7ff6a3fd80e8 in testing::internal::TestEventRepeater::OnTestEnd(class testing::TestInfo const \u0026) C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\googletest\\src\\googletest\\src\\gtest.cc:3916:1\n    #15 0x7ff6a3fceecd in testing::TestInfo::Run(void) C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\googletest\\src\\googletest\\src\\gtest.cc:2923:13\n    #16 0x7ff6a3fd0287 in testing::TestSuite::Run(void) C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\googletest\\src\\googletest\\src\\gtest.cc:3069:30\n    #17 0x7ff6a3ff397d in testing::internal::UnitTestImpl::RunAllTests(void) C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\googletest\\src\\googletest\\src\\gtest.cc:5939:44\n    #18 0x7ff6a4001bd1 in testing::internal::HandleSehExceptionsInMethodIfSupported\u003cclass testing::internal::UnitTestImpl, bool\u003e(class testing::internal::UnitTestImpl *, bool (__cdecl testing::internal::UnitTestImpl::*)(void), char const *) C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\googletest\\src\\googletest\\src\\gtest.cc:2641:12\n    #19 0x7ff6a3ff2e22 in testing::UnitTest::Run(void) C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\googletest\\src\\googletest\\src\\gtest.cc:5508:10\n    #20 0x7ff6a40b28cf in RUN_ALL_TESTS C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\googletest\\src\\googletest\\include\\gtest\\gtest.h:2311\n    #21 0x7ff6a40b28cf in webrtc::`anonymous namespace\u0027::TestMainImpl::Run C:\\b\\s\\w\\ir\\cache\\builder\\src\\test\\test_main_lib.cc:226:21\n    #22 0x7ff6a38e7bd5 in main C:\\b\\s\\w\\ir\\cache\\builder\\src\\test\\test_main.cc:33:16\n    #23 0x7ff6a61a3a13 in invoke_main d:\\A01\\_work\\6\\s\\src\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl:78\n    #24 0x7ff6a61a3a13 in __scrt_common_main_seh d:\\A01\\_work\\6\\s\\src\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl:288\n    #25 0x7ffd01c32773  (C:\\Windows\\System32\\KERNEL32.DLL+0x180012773)\n    #26 0x7ffd03af0d50  (C:\\Windows\\SYSTEM32\\ntdll.dll+0x180070d50)\n\n0x129ae2b72040 is located 0 bytes inside of 256-byte region [0x129ae2b72040,0x129ae2b72140)\nfreed by thread T0 here:\n    #0 0x7ff6a414b32b in free C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\llvm\\compiler-rt\\lib\\asan\\asan_malloc_win.cpp:82\n    #1 0x7ff6a428bde1 in rtc::Thread::`scalar deleting dtor\u0027(unsigned int) C:\\b\\s\\w\\ir\\cache\\builder\\src\\rtc_base\\thread.h:398\n    #2 0x7ff6a2a5044d in std::__1::default_delete\u003crtc::Thread\u003e::operator() C:\\b\\s\\w\\ir\\cache\\builder\\src\\buildtools\\third_party\\libc++\\trunk\\include\\__memory\\unique_ptr.h:54\n    #3 0x7ff6a2a5044d in std::__1::unique_ptr\u003crtc::Thread,std::__1::default_delete\u003crtc::Thread\u003e \u003e::reset C:\\b\\s\\w\\ir\\cache\\builder\\src\\buildtools\\third_party\\libc++\\trunk\\include\\__memory\\unique_ptr.h:315\n    #4 0x7ff6a2a5044d in std::__1::unique_ptr\u003crtc::Thread,std::__1::default_delete\u003crtc::Thread\u003e \u003e::~unique_ptr C:\\b\\s\\w\\ir\\cache\\builder\\src\\buildtools\\third_party\\libc++\\trunk\\include\\__memory\\unique_ptr.h:269\n    #5 0x7ff6a2a5044d in webrtc::PeerConnectionIntegrationBaseTest::~PeerConnectionIntegrationBaseTest(void) C:\\b\\s\\w\\ir\\cache\\builder\\src\\pc\\test\\integration_test_helpers.h:1402:3\n    #6 0x7ff6a29a37af in webrtc::`anonymous namespace\u0027::DataChannelIntegrationTest::~DataChannelIntegrationTest C:\\b\\s\\w\\ir\\cache\\builder\\src\\pc\\data_channel_integrationtest.cc:60\n    #7 0x7ff6a29a37af in webrtc::`anonymous namespace\u0027::DataChannelIntegrationTest_DataChannelWhileDisconnected_Test::~DataChannelIntegrationTest_DataChannelWhileDisconnected_Test C:\\b\\s\\w\\ir\\cache\\builder\\src\\pc\\data_channel_integrationtest.cc:580:1\n    #8 0x7ff6a4001815 in testing::internal::HandleSehExceptionsInMethodIfSupported\u003cclass testing::TestSuite, void\u003e(class testing::TestSuite *, void (__cdecl testing::TestSuite::*)(void), char const *) C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\googletest\\src\\googletest\\src\\gtest.cc:2641:12\n    #9 0x7ff6a3fced70 in testing::internal::HandleExceptionsInMethodIfSupported C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\googletest\\src\\googletest\\src\\gtest.cc:2711\n    #10 0x7ff6a3fced70 in testing::TestInfo::Run(void) C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\googletest\\src\\googletest\\src\\gtest.cc:2916:5\n    #11 0x7ff6a3fd0287 in testing::TestSuite::Run(void) C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\googletest\\src\\googletest\\src\\gtest.cc:3069:30\n    #12 0x7ff6a3ff397d in testing::internal::UnitTestImpl::RunAllTests(void) C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\googletest\\src\\googletest\\src\\gtest.cc:5939:44\n    #13 0x7ff6a4001bd1 in testing::internal::HandleSehExceptionsInMethodIfSupported\u003cclass testing::internal::UnitTestImpl, bool\u003e(class testing::internal::UnitTestImpl *, bool (__cdecl testing::internal::UnitTestImpl::*)(void), char const *) C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\googletest\\src\\googletest\\src\\gtest.cc:2641:12\n    #14 0x7ff6a3ff2e22 in testing::UnitTest::Run(void) C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\googletest\\src\\googletest\\src\\gtest.cc:5508:10\n    #15 0x7ff6a40b28cf in RUN_ALL_TESTS C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\googletest\\src\\googletest\\include\\gtest\\gtest.h:2311\n    #16 0x7ff6a40b28cf in webrtc::`anonymous namespace\u0027::TestMainImpl::Run C:\\b\\s\\w\\ir\\cache\\builder\\src\\test\\test_main_lib.cc:226:21\n    #17 0x7ff6a38e7bd5 in main C:\\b\\s\\w\\ir\\cache\\builder\\src\\test\\test_main.cc:33:16\n    #18 0x7ff6a61a3a13 in invoke_main d:\\A01\\_work\\6\\s\\src\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl:78\n    #19 0x7ff6a61a3a13 in __scrt_common_main_seh d:\\A01\\_work\\6\\s\\src\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl:288\n    #20 0x7ffd01c32773  (C:\\Windows\\System32\\KERNEL32.DLL+0x180012773)\n    #21 0x7ffd03af0d50  (C:\\Windows\\SYSTEM32\\ntdll.dll+0x180070d50)\n\npreviously allocated by thread T0 here:\n    #0 0x7ff6a414b42b in malloc C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\llvm\\compiler-rt\\lib\\asan\\asan_malloc_win.cpp:98\n    #1 0x7ff6a61a2416 in operator new(unsigned __int64) d:\\A01\\_work\\6\\s\\src\\vctools\\crt\\vcstartup\\src\\heap\\new_scalar.cpp:35\n    #2 0x7ff6a29a6aa3 in webrtc::PeerConnectionIntegrationBaseTest::PeerConnectionIntegrationBaseTest(enum webrtc::SdpSemantics, class absl::optional\u003cclass std::__1::basic_string\u003cchar, struct std::__1::char_traits\u003cchar\u003e, class std::__1::allocator\u003cchar\u003e\u003e\u003e) C:\\b\\s\\w\\ir\\cache\\builder\\src\\pc\\test\\integration_test_helpers.h:1367:25\n    #3 0x7ff6a2d15b65 in webrtc::`anonymous namespace\u0027::PeerConnectionIntegrationTest::PeerConnectionIntegrationTest C:\\b\\s\\w\\ir\\cache\\builder\\src\\pc\\peer_connection_integrationtest.cc:103:9\n    #4 0x7ff6a2e1425a in webrtc::`anonymous namespace\u0027::PeerConnectionIntegrationTest_IceTransportFactoryUsedForConnections_Test::PeerConnectionIntegrationTest_IceTransportFactoryUsedForConnections_Test C:\\b\\s\\w\\ir\\cache\\builder\\src\\pc\\peer_connection_integrationtest.cc:2829\n    #5 0x7ff6a2e1425a in testing::internal::ParameterizedTestFactory\u003cwebrtc::(anonymous namespace)::PeerConnectionIntegrationTest_IceTransportFactoryUsedForConnections_Test\u003e::CreateTest C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\googletest\\src\\googletest\\include\\gtest\\internal\\gtest-param-util.h:402:16\n    #6 0x7ff6a4001bd1 in testing::internal::HandleSehExceptionsInMethodIfSupported\u003cclass testing::internal::UnitTestImpl, bool\u003e(class testing::internal::UnitTestImpl *, bool (__cdecl testing::internal::UnitTestImpl::*)(void), char const *) C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\googletest\\src\\googletest\\src\\gtest.cc:2641:12\n    #7 0x7ff6a3fceca2 in testing::TestInfo::Run(void) C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\googletest\\src\\googletest\\src\\gtest.cc:2900:22\n    #8 0x7ff6a3fd0287 in testing::TestSuite::Run(void) C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\googletest\\src\\googletest\\src\\gtest.cc:3069:30\n    #9 0x7ff6a3ff397d in testing::internal::UnitTestImpl::RunAllTests(void) C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\googletest\\src\\googletest\\src\\gtest.cc:5939:44\n    #10 0x7ff6a4001bd1 in testing::internal::HandleSehExceptionsInMethodIfSupported\u003cclass testing::internal::UnitTestImpl, bool\u003e(class testing::internal::UnitTestImpl *, bool (__cdecl testing::internal::UnitTestImpl::*)(void), char const *) C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\googletest\\src\\googletest\\src\\gtest.cc:2641:12\n    #11 0x7ff6a3ff2e22 in testing::UnitTest::Run(void) C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\googletest\\src\\googletest\\src\\gtest.cc:5508:10\n    #12 0x7ff6a40b28cf in RUN_ALL_TESTS C:\\b\\s\\w\\ir\\cache\\builder\\src\\third_party\\googletest\\src\\googletest\\include\\gtest\\gtest.h:2311\n    #13 0x7ff6a40b28cf in webrtc::`anonymous namespace\u0027::TestMainImpl::Run C:\\b\\s\\w\\ir\\cache\\builder\\src\\test\\test_main_lib.cc:226:21\n    #14 0x7ff6a38e7bd5 in main C:\\b\\s\\w\\ir\\cache\\builder\\src\\test\\test_main.cc:33:16\n    #15 0x7ff6a61a3a13 in invoke_main d:\\A01\\_work\\6\\s\\src\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl:78\n    #16 0x7ff6a61a3a13 in __scrt_common_main_seh d:\\A01\\_work\\6\\s\\src\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl:288\n    #17 0x7ffd01c32773  (C:\\Windows\\System32\\KERNEL32.DLL+0x180012773)\n    #18 0x7ffd03af0d50  (C:\\Windows\\SYSTEM32\\ntdll.dll+0x180070d50)\n```",
      "parentUuid": "c1efa6d0_b980179a",
      "revId": "5f06a74c8e57af89888e360f09e1720298f9e274",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "1c15d4f6_7c02a1b8",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 7
      },
      "lineNbr": 0,
      "author": {
        "id": 5508
      },
      "writtenOn": "2022-03-16T14:30:14Z",
      "side": 1,
      "message": "Same experience with RunLoop + Flush() at the end of the test?",
      "parentUuid": "bedcda20_73f28b3f",
      "revId": "5f06a74c8e57af89888e360f09e1720298f9e274",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    }
  ]
}