{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "566b003c_24980d81",
        "filename": "/COMMIT_MSG",
        "patchSetId": 17
      },
      "lineNbr": 14,
      "author": {
        "id": 5142
      },
      "writtenOn": "2023-01-12T10:27:27Z",
      "side": 1,
      "message": "This CL adds the necessary interfaces and plumbing, but the issue will not be fixed until AudioDeviceModule::GetStats() is implemented, so I\u0027m not sure this should be \"Fixed:\".\n\nNote that when this does get implemented in Chromium and exercised by browser tests, this allowlist will need to update (assuming ADM is exercised in this loopback page):\nhttps://source.chromium.org/chromium/chromium/src/+/main:chrome/test/data/webrtc/peerconnection_getstats.js;l\u003d155;drc\u003d184de3f1efc0884b34173fabd93b6a8578d52478",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ccf309e5_599846de",
        "filename": "/COMMIT_MSG",
        "patchSetId": 17
      },
      "lineNbr": 14,
      "author": {
        "id": 19614
      },
      "writtenOn": "2023-01-16T08:32:56Z",
      "side": 1,
      "message": "Removed Fixed.\nInteresting, when I run this demo in my chromium prototype which implements the new ADM interface, then the new stat is visible even without changing that file.\nhttps://webrtc.github.io/samples/src/content/peerconnection/constraints/",
      "parentUuid": "566b003c_24980d81",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "8834400b_b2d3d514",
        "filename": "/COMMIT_MSG",
        "patchSetId": 17
      },
      "lineNbr": 14,
      "author": {
        "id": 5142
      },
      "writtenOn": "2023-01-16T11:05:12Z",
      "side": 1,
      "message": "The allow list is test-only, it is checked in WebRtcBrowserTest.RunsAudioVideoWebRTCCallInTwoTabsGetStatsPromise. The idea is that a change causes new metrics to be exposed to JavaScript without Chromium layer approval, the test should fail, but it will not filtering out the metrics outside of testing, so I would expect you to be able to compile your changes locally and see them on the web.\n\nIt is not bullet-proof (e.g. if the metric is not exposed by default in a 1:1 loopback call with defaults negotiated), but it has been good guard against shipping non-standard metrics to the web without approvals. This was commonly a problem in the past with the legacy stats API.\n\nIf it is working as intended, you\u0027ll need to update this allow list for your chromium CL to land or else some bot will fail that test but it is not needed to land this CL because even with this CL all metrics are undefined (no value set), so they don\u0027t show up in JS.",
      "parentUuid": "ccf309e5_599846de",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "32e0e0d2_49e79390",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 17
      },
      "lineNbr": 0,
      "author": {
        "id": 19614
      },
      "writtenOn": "2023-01-11T12:31:50Z",
      "side": 1,
      "message": "PTAL!",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "f24c5e30_6e442e97",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 17
      },
      "lineNbr": 0,
      "author": {
        "id": 5826
      },
      "writtenOn": "2023-01-12T09:10:27Z",
      "side": 1,
      "message": "Nice! LGTM but wait for hbos\u0027s approval.",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9004b40d_b35a1995",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 17
      },
      "lineNbr": 0,
      "author": {
        "id": 5142
      },
      "writtenOn": "2023-01-12T10:27:27Z",
      "side": 1,
      "message": "Looking good, but I\u0027d like some refactoring to avoid per-transceiver polling, and I\u0027m also not sure when the ID would increment",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9e7b912e_4602f729",
        "filename": "api/stats/rtcstats_objects.h",
        "patchSetId": 17
      },
      "lineNbr": 682,
      "author": {
        "id": 5142
      },
      "writtenOn": "2023-01-12T10:27:27Z",
      "side": 1,
      "message": "RTCInboundRtpStreamStats should also have a playoutId that references this stats object, when applicable.\n\nhttps://w3c.github.io/webrtc-stats/#dom-rtcinboundrtpstreamstats-playoutid",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "298bbeef_66abb105",
        "filename": "api/stats/rtcstats_objects.h",
        "patchSetId": 17
      },
      "lineNbr": 682,
      "author": {
        "id": 19614
      },
      "writtenOn": "2023-01-16T08:32:56Z",
      "side": 1,
      "message": "Removed the ID because it\u0027s singleton, in accordance with your other comments.",
      "parentUuid": "9e7b912e_4602f729",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b082bacf_4f319f4a",
        "filename": "media/base/media_channel.h",
        "patchSetId": 17
      },
      "lineNbr": 730,
      "author": {
        "id": 5142
      },
      "writtenOn": "2023-01-12T10:27:27Z",
      "side": 1,
      "message": "We have one VoiceMediaInfo per (audio) transceiver, but we\u0027ll have one transceiver per receiver, i.e. per audio RTP stream.\n\nThe playout stats are not per stream, it is a singleton, so this is the wrong place to put it. See other comment.",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d9bb45f0_bd9fee91",
        "filename": "media/base/media_channel.h",
        "patchSetId": 17
      },
      "lineNbr": 730,
      "author": {
        "id": 19614
      },
      "writtenOn": "2023-01-16T08:32:56Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "b082bacf_4f319f4a",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ba237a31_70c43537",
        "filename": "media/engine/webrtc_voice_engine.cc",
        "patchSetId": 17
      },
      "lineNbr": 2434,
      "author": {
        "id": 5142
      },
      "writtenOn": "2023-01-12T10:27:27Z",
      "side": 1,
      "message": "Other than this conceptually being the wrong place to put it, we also end up poling GetStats() once per transceiver, which is unnecessary. We\u0027d typically have 4 audio transceivers in a call, all of them referencing the same WebRtcVoiceEngine singleton.\n\nInstead, can we move this to WebRtcVoiceEngine::GetAudioDeviceModuleStats()?\n\nI think you should be able to call a function like that from RTCStatsCollector by adding a helper method to PeerConnectionInternal.\n\nHere is a similar example of getting something from the engine:\nhttps://source.chromium.org/chromium/chromium/src/+/main:third_party/webrtc/pc/peer_connection.cc;l\u003d1728;drc\u003dcf439a04e5df8889f4be985c1b76aa09b7d3e721\n\nI think you just need to add GetAudioDeviceModuleStats() to the VoiceEngineInterface (impl by WebRtcVoiceEngine) and PeerConnectionInternal (impl by PeerConnection). Then the collector gets the stats from there as opposed to getting it from the transceiver.",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "79d8ac79_152a6dbb",
        "filename": "media/engine/webrtc_voice_engine.cc",
        "patchSetId": 17
      },
      "lineNbr": 2434,
      "author": {
        "id": 19614
      },
      "writtenOn": "2023-01-16T08:32:56Z",
      "side": 1,
      "message": "Thanks for the guidance, done. Is this what you had in mind?",
      "parentUuid": "ba237a31_70c43537",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "012aea0f_65c15aab",
        "filename": "media/engine/webrtc_voice_engine.cc",
        "patchSetId": 17
      },
      "lineNbr": 2434,
      "author": {
        "id": 5142
      },
      "writtenOn": "2023-01-16T11:05:12Z",
      "side": 1,
      "message": "Yes!",
      "parentUuid": "79d8ac79_152a6dbb",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a34485bf_7cee9d58",
        "filename": "modules/audio_device/include/audio_device.h",
        "patchSetId": 17
      },
      "lineNbr": 46,
      "author": {
        "id": 5142
      },
      "writtenOn": "2023-01-12T10:27:27Z",
      "side": 1,
      "message": "Considering we only have one voice engine, and thus one set of these stats at a time, do we even need an `id`?\n\nThe ID would be needed if the playout device can be destroyed and re-created during the lifetime of an RTCPeerConnection. Incrementing the ID would be a good thing to do if the stats are reset... but if this does not happen during a PC\u0027s lifetime then it\u0027s not needed.\n\nHow many \"audio device playouts\" will we observe?",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b82355e5_754b4c52",
        "filename": "modules/audio_device/include/audio_device.h",
        "patchSetId": 17
      },
      "lineNbr": 46,
      "author": {
        "id": 5142
      },
      "writtenOn": "2023-01-12T11:37:56Z",
      "side": 1,
      "message": "Yeah looks like a singleton, no ID needed?\nhttps://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/modules/peerconnection/peer_connection_dependency_factory.cc;l\u003d958;drc\u003d3c15773d007439201c5d3f03d09aab8a4d96b956\n\nWe can use a hardcoded constant, that\u0027s what we do for the \"peer-connection\" stats object, for which there is only ever 1 instance",
      "parentUuid": "a34485bf_7cee9d58",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "b418f196_0987b141",
        "filename": "modules/audio_device/include/audio_device.h",
        "patchSetId": 17
      },
      "lineNbr": 46,
      "author": {
        "id": 19614
      },
      "writtenOn": "2023-01-16T08:32:56Z",
      "side": 1,
      "message": "Ah cool, removing the ID then, and setting the RTCStats id to a hardcoded \"AP\"",
      "parentUuid": "b82355e5_754b4c52",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a186baf2_cf2f9081",
        "filename": "modules/audio_device/include/audio_device.h",
        "patchSetId": 17
      },
      "lineNbr": 46,
      "author": {
        "id": 5142
      },
      "writtenOn": "2023-01-16T11:05:12Z",
      "side": 1,
      "message": "SGTM!",
      "parentUuid": "b418f196_0987b141",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f6e1dc0d_290fd02a",
        "filename": "modules/audio_device/include/audio_device.h",
        "patchSetId": 17
      },
      "lineNbr": 167,
      "author": {
        "id": 5091
      },
      "writtenOn": "2023-01-12T10:33:21Z",
      "side": 1,
      "message": "Why is this API added to the ADM? The ADM is not even built in Chrome so I don\u0027t see how this would work.",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d9cfce76_8e54fd04",
        "filename": "modules/audio_device/include/audio_device.h",
        "patchSetId": 17
      },
      "lineNbr": 167,
      "author": {
        "id": 19614
      },
      "writtenOn": "2023-01-16T08:32:56Z",
      "side": 1,
      "message": "ADM is implemented in chromium by WebRtcAudioDeviceNotImpl\nhttps://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/modules/webrtc/webrtc_audio_device_not_impl.h;l\u003d23;drc\u003d3c15773d007439201c5d3f03d09aab8a4d96b956\nwhich is in turn extended by WebRtcAudioDeviceImpl.",
      "parentUuid": "f6e1dc0d_290fd02a",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "e89c7ba5_a8134f82",
        "filename": "modules/audio_device/include/audio_device.h",
        "patchSetId": 17
      },
      "lineNbr": 167,
      "author": {
        "id": 5091
      },
      "writtenOn": "2023-01-16T08:41:33Z",
      "side": 1,
      "message": "That part is only empty methods for what is NOT implemented in Chrome. https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/modules/webrtc/webrtc_audio_device_impl.cc contains an implementation of a small fraction of the interface but my point is that none of the ADM code in native WebRTC is included in Chrome. The part that is implemented in the renderer in Chrome does not contain any native audio parts and is only a \"dumb\" receiver of audio from the real ADM in the audio process. It was not clear to me if this was sufficient or not. Again, Chrome only has real implementation of about 20% of the full interface. If that is sufficient, I am fine but I just wanted to make it clear.",
      "parentUuid": "d9cfce76_8e54fd04",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "03778010_feb514dd",
        "filename": "modules/audio_device/include/audio_device.h",
        "patchSetId": 17
      },
      "lineNbr": 167,
      "author": {
        "id": 19614
      },
      "writtenOn": "2023-01-16T09:00:16Z",
      "side": 1,
      "message": "I see, thanks for the explanation. This is sufficient, if you want you can look at my chromium-side CL (not ready for review, but it works):\nhttps://chromium-review.googlesource.com/c/chromium/src/+/4154699\nIf you run these CLs together then the added stats will show up correctly in getStats().",
      "parentUuid": "e89c7ba5_a8134f82",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "2c8935c1_09c9e7ba",
        "filename": "modules/audio_device/include/audio_device.h",
        "patchSetId": 17
      },
      "lineNbr": 167,
      "author": {
        "id": 5091
      },
      "writtenOn": "2023-01-16T12:08:51Z",
      "side": 1,
      "message": "All good",
      "parentUuid": "03778010_feb514dd",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f7fcf8de_96769ee9",
        "filename": "pc/rtc_stats_collector.cc",
        "patchSetId": 17
      },
      "lineNbr": 2003,
      "author": {
        "id": 5142
      },
      "writtenOn": "2023-01-12T10:27:27Z",
      "side": 1,
      "message": "Here in the inbound-rtp case, I would expect \"inbound-rtp.playoutId\" to have a value if and only if...\n1. A playout-stats object exist.\n2. The transceiver is of kind audio, and\n3. Transceiver\u0027s current_direction() is kSendRecv or kRecvOnly.\n\nIn other words, transceivers that are currently receiving would contribute to playout, but not other transceivers. (Maybe technically the transceiver.receiver.track also has to have a sink, but I\u0027m ignoring that edge case, not sure how to check that)\n\nFor threading reasons, calling \"stats.transceiver-\u003ecurrent_direction()\" would be a block-invoke here, which is not allowed.\n\nBut if you patch RtpTransceiverStatsInfo to contain the current_direction, then you can save the value of current_direction from PrepareTransceiverStatsInfosAndCallStats_s_w_n().",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "caebe4a7_8ee0b2cd",
        "filename": "pc/rtc_stats_collector.cc",
        "patchSetId": 17
      },
      "lineNbr": 2003,
      "author": {
        "id": 19614
      },
      "writtenOn": "2023-01-16T08:32:56Z",
      "side": 1,
      "message": "Is this comment still relevant, now that we no longer have a unique id for RTCAudioPlayoutStats?",
      "parentUuid": "f7fcf8de_96769ee9",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "27bb39a3_60f12ace",
        "filename": "pc/rtc_stats_collector.cc",
        "patchSetId": 17
      },
      "lineNbr": 2003,
      "author": {
        "id": 5142
      },
      "writtenOn": "2023-01-16T11:05:12Z",
      "side": 1,
      "message": "Yes it is still relevant, the fact that our browser implementation only has a single playout stat might not be true on other browsers. So without making any assumptions about browser implementations, how would you know which \"media-playout\" stats object is relevant for your RTP stream? It is also true that not all RTP streams might be playing out, so not all of them are necessarily contributing to playout.\n\nI don\u0027t think we should ship \"media-playout\" without also shipping \"inbound-rtp.playoutId\" in the same milestone because otherwise apps will start depending on browser-specific behavior and just search for the type rather than lookup of what is referenced. That could happen anyway of course, but it should be possible to do ID lookup the right way.\n\nThat said I think it is OK to land the playoudId in a follow-up CL so that we can land this one. It will aid CL reviewability to do one thing at a time. Suggestion:\n1. Land this CL first.\n2. Then a CL that adds playoutId.\n3. And finally the Chromium CL which make use of 1+2.",
      "parentUuid": "caebe4a7_8ee0b2cd",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6c333502_33239436",
        "filename": "pc/rtc_stats_collector.cc",
        "patchSetId": 17
      },
      "lineNbr": 2003,
      "author": {
        "id": 19614
      },
      "writtenOn": "2023-01-16T13:01:40Z",
      "side": 1,
      "message": "Will do!",
      "parentUuid": "27bb39a3_60f12ace",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "322de6da_4f6bda8f",
        "filename": "pc/rtc_stats_collector.cc",
        "patchSetId": 17
      },
      "lineNbr": 2090,
      "author": {
        "id": 5142
      },
      "writtenOn": "2023-01-12T10:27:27Z",
      "side": 1,
      "message": "Since all playout stats would have the same ID, this call will happen multiple times but only one of the objects survive in the end. This becomes a non-issue if you address my other comments.",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d512031c_ed3833a9",
        "filename": "pc/rtc_stats_collector.cc",
        "patchSetId": 17
      },
      "lineNbr": 2090,
      "author": {
        "id": 19614
      },
      "writtenOn": "2023-01-16T08:32:56Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "322de6da_4f6bda8f",
      "revId": "15be9b37cdab9ad500f8c0651d6a1f944b536fa6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    }
  ]
}