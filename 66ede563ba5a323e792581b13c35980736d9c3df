{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "ac1bf7ad_56f11439",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 7
      },
      "lineNbr": 0,
      "author": {
        "id": 18005
      },
      "writtenOn": "2024-11-13T08:48:24Z",
      "side": 1,
      "message": "PTAL. The different approach of codecs handling scalability mode in video_codec_initializer is the most confusing part for me, especially when simulcast is involved.\n\nFor example, For AV1, in video_codec_initializer.cc, it calls SetAV1SvcConfig() with the last simulcast layer\u0027s num_temporal_layers, and then use this num_temporal_layer information to set the top-level video_codec scalability mode. in SetAv1SvcConfig. Why that? What if application sets different scalability mode for different simulcast layers?\n\nAlso it seems whether num_temporal_layers and scalability_mode setting at each simulcat layer is already configured or not when SetupCodec is called is very undeterministic,which makes the attempt to enable simulcast temporal scalability difficult.",
      "revId": "66ede563ba5a323e792581b13c35980736d9c3df",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "3647585d_83cb62e3",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 7
      },
      "lineNbr": 0,
      "author": {
        "id": 5117
      },
      "writtenOn": "2024-11-13T09:14:09Z",
      "side": 1,
      "message": "\u003e The SimulcastRateAllocator was designed for VP8 so avoid using it\nwhenever possible.\n\nI don\u0027t agree with the logic here. The only VP8 specific things there are the default bitrates, which is possible to set per codec (see vp9 config for example [1])\n\nThen, for singlecast scenarios there\u0027s no difference in behavior between SvcRateAllocator and SimulcastRateAllocator. Maybe temporal layers allocation is slightly different, but it\u0027s a very small change. \n\nOr did you mean a single stream with SVC? But all your changes opperate with only 0th spatial layer.\n\nI believe the best way forward is to set the per-codec bitrates in simulcast.cc and leave it to use SimulcastRateAllocator.\n\n[1] https://source.chromium.org/chromium/chromium/src/+/main:third_party/webrtc/video/config/simulcast.cc;l\u003d111;drc\u003d8037fc6ffa131805248c2a63c3edec69155b05cf",
      "revId": "66ede563ba5a323e792581b13c35980736d9c3df",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "84d9f66d_e97ea60d",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 7
      },
      "lineNbr": 0,
      "author": {
        "id": 18005
      },
      "writtenOn": "2024-11-13T09:22:40Z",
      "side": 1,
      "message": "However, for VP9 and AV1 the single-cast stream is already on SvcRateAllocator: https://source.chromium.org/chromium/chromium/src/+/main:third_party/webrtc/api/video/builtin_video_bitrate_allocator_factory.cc;l\u003d37;drc\u003d52ea2c3d2a9c35f5744d0d3eadbae75d8506eb0f\n\nAlso according to the comment around that code, looks like WebRTC team\u0027s future plan is also moving to SvcRateAllocator for simulcast?",
      "parentUuid": "3647585d_83cb62e3",
      "revId": "66ede563ba5a323e792581b13c35980736d9c3df",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "bc3d0956_f892c896",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 7
      },
      "lineNbr": 0,
      "author": {
        "id": 5117
      },
      "writtenOn": "2024-11-13T09:29:24Z",
      "side": 1,
      "message": "It will be a single rate allocator in the future, yes. The main difference between the two is that SimulcastRA uses a table of bitrates, while SvcRA uses an implicit calculation based on a fixed ratio. The new one will also use a table. \n\nIt doesn\u0027t matter that much which of the two will be used right now. Since SimulcastRA already happens to be used, you just need to update the bitrates. The change will be smaller and clearer.\n\n@ssilkin@chromium.org WDYT?",
      "parentUuid": "84d9f66d_e97ea60d",
      "revId": "66ede563ba5a323e792581b13c35980736d9c3df",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "07d11ae7_fd230f6c",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 7
      },
      "lineNbr": 0,
      "author": {
        "id": 18005
      },
      "writtenOn": "2024-11-13T13:18:43Z",
      "side": 1,
      "message": "Thanks Ilya! If so, I would expect the only thing I need to do in video_codec_initializer.cc for H.265 specific, might be just setting top-level scalablity_mode to one of the unsupported scalability mode that\u0027s configured on the simulcast streams, in order to fail InitEncode() when that happens?",
      "parentUuid": "bc3d0956_f892c896",
      "revId": "66ede563ba5a323e792581b13c35980736d9c3df",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "04379122_395f90d2",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 7
      },
      "lineNbr": 0,
      "author": {
        "id": 5117
      },
      "writtenOn": "2024-11-13T13:40:44Z",
      "side": 1,
      "message": "Could you provide more context please? I don\u0027t understand the issue here.",
      "parentUuid": "07d11ae7_fd230f6c",
      "revId": "66ede563ba5a323e792581b13c35980736d9c3df",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "51bc7949_a37c4d80",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 7
      },
      "lineNbr": 0,
      "author": {
        "id": 18005
      },
      "writtenOn": "2024-11-13T14:04:03Z",
      "side": 1,
      "message": "I understand the encode stream factory relies on the threshold tables you mentioned to generate the VideoEncoderConfig and stream vectors; They will be used to setup the VideoCodec structure via VideoCodecInitalizer::SetupCodec(). The VideoCodec structure will be sent to SimulcastRA for bitrate allocation.\n\nI\u0027m trying to confirm that there is no further change required to VideoCodecInitalizer::SetupCodec() if I switch to SimulcastRA.",
      "parentUuid": "04379122_395f90d2",
      "revId": "66ede563ba5a323e792581b13c35980736d9c3df",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d80045e8_8bef8317",
        "filename": "modules/video_coding/video_codec_initializer.cc",
        "patchSetId": 7
      },
      "lineNbr": 374,
      "author": {
        "id": 5142
      },
      "writtenOn": "2024-11-13T09:01:08Z",
      "side": 1,
      "message": "What about max_bitrate_bps? (From JS API only maxBitrate can be controlled, not minBitrate so that should be more important)",
      "revId": "66ede563ba5a323e792581b13c35980736d9c3df",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "81c70236_3e314982",
        "filename": "modules/video_coding/video_codec_initializer.cc",
        "patchSetId": 7
      },
      "lineNbr": 374,
      "author": {
        "id": 18005
      },
      "writtenOn": "2024-11-13T09:05:24Z",
      "side": 1,
      "message": "That\u0027s what I am also trying to ask. I follow AV1\u0027s approach above...",
      "parentUuid": "d80045e8_8bef8317",
      "revId": "66ede563ba5a323e792581b13c35980736d9c3df",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    }
  ]
}