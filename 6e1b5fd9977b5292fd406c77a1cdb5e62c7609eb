{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "072e7eb9_2b9edc13",
        "filename": "video/video_stream_encoder.cc",
        "patchSetId": 2
      },
      "lineNbr": 1118,
      "author": {
        "id": 5117
      },
      "writtenOn": "2021-07-05T09:15:32Z",
      "side": 1,
      "message": "I don\u0027t like this change, because now the |alignment| may be computed in different places based on complicated and unobvious logic. \n\nAlso it won\u0027t work like that: before the alignment is communicated to the source, the resolution here may be not good, and the InitEncode() call will fail (as in https://chromium-review.googlesource.com/c/chromium/src/+/2995112). Then encoder will be released at line 1100. Then the GetEncoderInfo() call below will cause segfault.\n\n+cc dalecurtis@\n\nDale, What information is the RtcVideoEncoder missing, so it can\u0027t provide alignment info before the InitEncode call? Is it waiting for the actual selected codec (vp8 vs h264)? But that information is there at the creation time. And webrtc guarantees that it will pass the same codec to the encode, which was used during creation time.\n\nI believe more logical change is to return correct alignment in RtcVideoEncoder even before InitEncode is called (based on |profile_|).\n\nMaybe you can create |impl_| at the creation of RtcVideoEncoder? When set video_content_mode_ separately at the initialization?",
      "revId": "6e1b5fd9977b5292fd406c77a1cdb5e62c7609eb",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "66757862_e09c702f",
        "filename": "video/video_stream_encoder.cc",
        "patchSetId": 2
      },
      "lineNbr": 1118,
      "author": {
        "id": 6008
      },
      "writtenOn": "2021-07-07T17:49:48Z",
      "side": 1,
      "message": "It\u0027s not sufficient to hardcode the values at construction of the RTCVE currently (I tried that), but we certainly can do that if it\u0027s needed after this change. In this case it\u0027s just a hardcoded value based on platform.",
      "parentUuid": "072e7eb9_2b9edc13",
      "revId": "6e1b5fd9977b5292fd406c77a1cdb5e62c7609eb",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "799cfe50_8d0f12f9",
        "filename": "video/video_stream_encoder.cc",
        "patchSetId": 2
      },
      "lineNbr": 1118,
      "author": {
        "id": 5117
      },
      "writtenOn": "2021-07-08T08:43:29Z",
      "side": 1,
      "message": "It\u0027s not sufficient probably because of this finch trial: https://source.chromium.org/chromium/chromium/src/+/main:third_party/webrtc/media/engine/simulcast_encoder_adapter.cc;l\u003d791;drc\u003d8f93beff3b0c31250766e3a1b4e1313b00a7507f\n\nIt\u0027s configured from \"WebRTC-SimulcastEncoderAdapter-GetEncoderInfoOverride\" field trial.\n\nPlease check what the alignment is 16 at the beginning of this function.",
      "parentUuid": "66757862_e09c702f",
      "revId": "6e1b5fd9977b5292fd406c77a1cdb5e62c7609eb",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "70b8174f_ae449483",
        "filename": "video/video_stream_encoder.cc",
        "patchSetId": 2
      },
      "lineNbr": 1118,
      "author": {
        "id": 6008
      },
      "writtenOn": "2021-07-08T17:15:00Z",
      "side": 1,
      "message": "Unfortunately it\u0027s not the override, there\u0027s no override applied in my local build. You can test this for yourself by hardcoding 16 here https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/platform/peerconnection/rtc_video_encoder.cc;l\u003d1576;drc\u003d4a2c8763aaa2388f64612baa3d7a83e1a06a3a86 on any platform (doesn\u0027t need to be Android) and using the stats test page from the bug.",
      "parentUuid": "799cfe50_8d0f12f9",
      "revId": "6e1b5fd9977b5292fd406c77a1cdb5e62c7609eb",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7df40db0_efeb8383",
        "filename": "video/video_stream_encoder.cc",
        "patchSetId": 2
      },
      "lineNbr": 1118,
      "author": {
        "id": 5117
      },
      "writtenOn": "2021-07-09T14:31:11Z",
      "side": 1,
      "message": "I tried to do this. I used this page [2] to select h264, since it\u0027s the only HW supported codec on my windows machine (without it RtcVideoEncoder was skipped).\n\nAfter hardcoding alignment\u003d16 and all_simulcast_layers\u003dtrue there, I get 16 all the way at the source [1]\n\nNote, at the very beginning, before the actual encoder is initialized, there\u0027s some default encoder being initialized with alignment request 1 and the source does send a couple frames unaligned. However, no such frame makes it to the RtcVideoEncoder ever. I\u0027m not sure why this happens, but if you only look at the very first line in the logs you might see alignment\u003d1. Check the actual resolution at the RtcVideoEncoder.\n\n[1] https://source.chromium.org/chromium/chromium/src/+/main:third_party/webrtc/media/base/video_adapter.cc;l\u003d256;drc\u003dc2cc4d305a7c05a5de2cc957ffc94806a45d54a8\n\n[2] https://webrtc.github.io/samples/src/content/peerconnection/change-codecs/",
      "parentUuid": "70b8174f_ae449483",
      "revId": "6e1b5fd9977b5292fd406c77a1cdb5e62c7609eb",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3db82633_09514755",
        "filename": "video/video_stream_encoder.cc",
        "patchSetId": 2
      },
      "lineNbr": 1118,
      "author": {
        "id": 6008
      },
      "writtenOn": "2021-07-09T17:53:23Z",
      "side": 1,
      "message": "Interesting. That definitely doesn\u0027t work on Android, here\u0027s the patch I just tested:\nhttps://chromium-review.googlesource.com/c/chromium/src/+/2995112/5/third_party/blink/renderer/platform/peerconnection/rtc_video_encoder.cc\n\n[ERROR:video_adapter.cc(272)] AdaptFrameResolution: 480x640, align\u003d1\n[ERROR:android_video_encode_accelerator.cc(243)] Encode: format:PIXEL_FORMAT_I420 storage_type:MOJO_SHARED_BUFFER coded_size:480x640 visible_rect:0,0 480x640 natural_size:480x640 timestamp:88918725823\n\n(I deleted the field trial overrides to be sure they weren\u0027t effecting anything).",
      "parentUuid": "7df40db0_efeb8383",
      "revId": "6e1b5fd9977b5292fd406c77a1cdb5e62c7609eb",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "56760b16_fa50136c",
        "filename": "video/video_stream_encoder.cc",
        "patchSetId": 2
      },
      "lineNbr": 1118,
      "author": {
        "id": 5117
      },
      "writtenOn": "2021-07-09T20:28:28Z",
      "side": 1,
      "message": "Interesting, now we need to bisect, where exactly is the pipeline broken. Maybe there\u0027s some other place which overrides it.\n\nCheck this:\nhttps://source.chromium.org/chromium/chromium/src/+/main:third_party/webrtc/video/video_stream_encoder.cc;l\u003d890;drc\u003db6d50e3a1758a808118170e6c6a6119e96356f3b\n\nIf it\u0027s broken here, (always 1) check this:\nhttps://source.chromium.org/chromium/chromium/src/+/main:third_party/webrtc/video/alignment_adjuster.cc;l\u003d71;drc\u003d8324b2da4aa6ce3c38ead55ff1f3c2844c21a0e5\n\nThe if both are correct - it\u0027s webrtc messed up. If the second is correct, it\u0027s  AlignmentAdjuster issue. If both are 1, then add the debug output on return value in GetEncodeInfo in SimulcastEncoderAdapter and VideoEncoderSoftwareFallbackWrapper",
      "parentUuid": "3db82633_09514755",
      "revId": "6e1b5fd9977b5292fd406c77a1cdb5e62c7609eb",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6d1af9f8_b00c23a7",
        "filename": "video/video_stream_encoder.cc",
        "patchSetId": 2
      },
      "lineNbr": 1118,
      "author": {
        "id": 6008
      },
      "writtenOn": "2021-07-09T21:35:48Z",
      "side": 1,
      "message": "As I noted on the other code review (https://chromium-review.googlesource.com/c/chromium/src/+/2995112/4..5/third_party/blink/renderer/platform/peerconnection/rtc_video_encoder.cc#b589) at least on Android the bad alignment comes from here: https://source.chromium.org/chromium/chromium/src/+/main:third_party/webrtc/media/engine/simulcast_encoder_adapter.cc;l\u003d820;drc\u003d70cd086644f883d28eb1f01d859c2950abe08e47\n\nHere\u0027s the logs showing that:\nhttps://bugs.chromium.org/p/chromium/issues/detail?id\u003d1084702#c43",
      "parentUuid": "56760b16_fa50136c",
      "revId": "6e1b5fd9977b5292fd406c77a1cdb5e62c7609eb",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    }
  ]
}