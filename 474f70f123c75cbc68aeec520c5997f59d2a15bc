{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "b17c97b7_037a008f",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 7,
      "author": {
        "id": 5122
      },
      "writtenOn": "2021-09-03T14:00:06Z",
      "side": 1,
      "message": "AgcManagerDirect: Fix the use of `use_clipping_predictor_step_`\n\nEvaluate a clipping predictor whenever injected, but keep using the predictions only when their usage is allowed.\n\nThis CL also adds unit tests to verify that the clipping predictor more aggressively lowers the analog gain when needed.",
      "range": {
        "startLine": 7,
        "startChar": 0,
        "endLine": 7,
        "endChar": 64
      },
      "revId": "474f70f123c75cbc68aeec520c5997f59d2a15bc",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "6f645690_1e55e16b",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 17719
      },
      "writtenOn": "2021-09-03T11:22:06Z",
      "side": 1,
      "message": "Hi Alessio and Minyue, can you please take a look? Thanks!",
      "revId": "474f70f123c75cbc68aeec520c5997f59d2a15bc",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "5433b4a9_487d0a5a",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 5122
      },
      "writtenOn": "2021-09-03T14:00:06Z",
      "side": 1,
      "message": "Thanks a lot for fixing the bug I added Hanna!\nI have some comments.",
      "revId": "474f70f123c75cbc68aeec520c5997f59d2a15bc",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ba505378_8006f3b3",
        "filename": "modules/audio_processing/agc/agc_manager_direct.cc",
        "patchSetId": 1
      },
      "lineNbr": 606,
      "author": {
        "id": 5122
      },
      "writtenOn": "2021-09-03T14:00:06Z",
      "side": 1,
      "message": "!!clipping_predictor_\n\nin this way we evaluate whenever a predictor is injected and regardless of whether the predictor is used or not",
      "range": {
        "startLine": 606,
        "startChar": 8,
        "endLine": 606,
        "endChar": 37
      },
      "revId": "474f70f123c75cbc68aeec520c5997f59d2a15bc",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9cba87a1_0ea9d6eb",
        "filename": "modules/audio_processing/agc/agc_manager_direct.cc",
        "patchSetId": 1
      },
      "lineNbr": 624,
      "author": {
        "id": 5122
      },
      "writtenOn": "2021-09-03T14:00:06Z",
      "side": 1,
      "message": "instead of changing the expressions in the if statements in this line and below (624, 630, 634) I would add the following just after line 622\n\n// Hide predictions if their usage is disabled so that no action\n// will be taken on predicted clipping.\nclipping_predicted \u0026\u003d use_clipping_predictor_step_;",
      "range": {
        "startLine": 624,
        "startChar": 39,
        "endLine": 624,
        "endChar": 57
      },
      "revId": "474f70f123c75cbc68aeec520c5997f59d2a15bc",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2de6a353_eda82c9f",
        "filename": "modules/audio_processing/agc/agc_manager_direct_unittest.cc",
        "patchSetId": 1
      },
      "lineNbr": 977,
      "author": {
        "id": 5122
      },
      "writtenOn": "2021-09-03T14:00:06Z",
      "side": 1,
      "message": "Thanks for adding unit tests! I think it\u0027s better to set a different expectation though, since this one sound a bit counterintuitive to me - if clipping prediction is disabled, then I would test that the analog gain is NOT lowered. Let  me clarify and propose an alternative.\n\nFirst of all, the tests should cover 3 cases:\n#1 ClippingPredictorConfig::enabled false (then ::use_predicted_step does not matter since there is nothing to evaluate)\n#2 ClippingPredictorConfig::enabled true\n  #2.a ::use_predicted_step false\n  #2.b ::use_predicted_step true\n\nCurrently, #1 and #2.b are tested, but not #2.a.\n\nNow let\u0027s think about the expectations.\n\nInstead of individually testing those 3 cases, we could add two tests to compare the behavior of #1 vs #2.a and #1 vs #2.b using the same sequence of `CallPreProcessAudioBuffer()` calls.\n\n\"#1 vs #2.a\"\nBoth controllers will produce the same sequence for `stream_analog_level()` because if clipping is predicted, but the predictions are not used, then the analog AGC behavior must not change.\nTEST(AgcManagerDirectStandaloneTest, UnusedClippingPredictionsProduceSameAnalogLevels)\n\n\"#1 vs #2.b\"\nIn this case instead we must observe lower values for `stream_analog_level()` in case #2.b compared to case #1.\nTEST(AgcManagerDirectStandaloneTest, UsedClippingPredictionsProduceLowerAnalogLevels)\n\nThose tests could replace `DetectedClippingWithUnusedPredictedStepLowersVolume` and `EnableClippingPredictorLowersVolume`. WDYT?\n\nPS: obviously the \"input\" sequence (I mean the `CallPreProcessAudioBuffer()` calls) should be tailored to reproduce the behavior we want to test and in the future the expectations might need to be adapted if the predictor accuracy changes",
      "range": {
        "startLine": 977,
        "startChar": 5,
        "endLine": 977,
        "endChar": 56
      },
      "revId": "474f70f123c75cbc68aeec520c5997f59d2a15bc",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    }
  ]
}