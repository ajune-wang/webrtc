{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "e539feda_bea67245",
        "filename": "modules/audio_processing/gain_controller2.cc",
        "patchSetId": 7
      },
      "lineNbr": 226,
      "author": {
        "id": 17719
      },
      "writtenOn": "2022-12-06T13:17:13Z",
      "side": 1,
      "message": "There used to be a check `if (speech_probability.has_value())` which I think we should keep because the method signature does allow passing an `absl::nullopt`. Same also for `speech_level_estimator_` above.\n\nWe actually shouldn\u0027t therefore expect `speech_probability` to have a value nor check it by `RTC_DCHECK(speech_probability.has_value())` here or above for `speech_level_estimator_`. Sorry for the [self-contradictory comment](https://webrtc-review.googlesource.com/c/src/+/286002/comment/2c7c2c37_7da55d95/) in the previous CL!",
      "range": {
        "startLine": 226,
        "startChar": 8,
        "endLine": 226,
        "endChar": 27
      },
      "revId": "329c1944a64b1a906706e0a01fb9d3126e8cf018",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2db02033_6b30d9fa",
        "filename": "modules/audio_processing/gain_controller2.cc",
        "patchSetId": 7
      },
      "lineNbr": 226,
      "author": {
        "id": 5122
      },
      "writtenOn": "2022-12-07T08:47:26Z",
      "side": 1,
      "message": "\u003e There used to be a check `if (speech_probability.has_value())` which I think we should keep because the method signature does allow passing an `absl::nullopt`. Same also for `speech_level_estimator_` above.\n\nThe speech probability argument in `InputVolumeController::Process()` is not optional anymore (changed in https://webrtc-review.googlesource.com/c/src/+/283700) and we should call `InputVolumeController::Process()` for each 10 ms frame.\n\n\u003e \n\u003e We actually shouldn\u0027t therefore expect `speech_probability` to have a value nor check it by `RTC_DCHECK(speech_probability.has_value())` here or above for `speech_level_estimator_`. Sorry for the [self-contradictory comment](https://webrtc-review.googlesource.com/c/src/+/286002/comment/2c7c2c37_7da55d95/) in the previous CL!\n\nWhen `input_volume_controller_` is set, the speech probability must be set as well.\n\nSo, the code above looks fine to me.",
      "parentUuid": "e539feda_bea67245",
      "range": {
        "startLine": 226,
        "startChar": 8,
        "endLine": 226,
        "endChar": 27
      },
      "revId": "329c1944a64b1a906706e0a01fb9d3126e8cf018",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0e15ccd1_9a42844c",
        "filename": "modules/audio_processing/gain_controller2.cc",
        "patchSetId": 7
      },
      "lineNbr": 226,
      "author": {
        "id": 17719
      },
      "writtenOn": "2022-12-07T10:25:54Z",
      "side": 1,
      "message": "It is possible to call the constructor so that `InputVolumeController` is instantiated but `use_internal_vad` is false, right? If so, this method can be called with and empty `speech_probability` in which case the code crashes.\n\nIf passing an empty probability and not instantiating VAD is an error in the configuration when either input volume controller or speech level estimator is used, we can also keep the DCHECKs to document the intended behaviour.",
      "parentUuid": "2db02033_6b30d9fa",
      "range": {
        "startLine": 226,
        "startChar": 8,
        "endLine": 226,
        "endChar": 27
      },
      "revId": "329c1944a64b1a906706e0a01fb9d3126e8cf018",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f7cef691_150d7528",
        "filename": "modules/audio_processing/gain_controller2.cc",
        "patchSetId": 7
      },
      "lineNbr": 226,
      "author": {
        "id": 5122
      },
      "writtenOn": "2022-12-07T12:28:30Z",
      "side": 1,
      "message": "\u003e It is possible to call the constructor so that `InputVolumeController` is instantiated but `use_internal_vad` is false, right? \n\nYes.\n\n\u003e If so, this method can be called with and empty `speech_probability` in which case the code crashes.\n\nYes and that\u0027s the correct behavior: that\u0027s why we have `RTC_DCHECK(speech_probability.has_value());` in line 222: it must not happen that `use_internal_vad` is false and that `speech_probability` remains unspecified. That would mean that the caller is not sticking to the API contract. Maybe I could clarify this in the `GainController2::Process()` docstring and add a death test. WDYT?\n\nAn alternative would be to make the `speech_probability` argument for `InputVolumeController::Process()` optional as it was before https://webrtc-review.googlesource.com/c/src/+/283700; but the purpose is not making AGC2 robust to incorrect usage. I rather prefer to keep in mind what will be the final shape of the code once a decision is taken on whether keeping or removing TS: namely, after that decision, we will either remove the `speech_probability` argument from `GainController2::Process()` or make it non-optional.\n\n\u003e \n\u003e If passing an empty probability and not instantiating VAD is an error in the configuration when either input volume controller or speech level estimator is used, we can also keep the DCHECKs to document the intended behaviour.\n\nYes, that\u0027s exactly the purpose of the DCHECK.",
      "parentUuid": "0e15ccd1_9a42844c",
      "range": {
        "startLine": 226,
        "startChar": 8,
        "endLine": 226,
        "endChar": 27
      },
      "revId": "329c1944a64b1a906706e0a01fb9d3126e8cf018",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1a484d94_0673534f",
        "filename": "modules/audio_processing/gain_controller2.cc",
        "patchSetId": 7
      },
      "lineNbr": 226,
      "author": {
        "id": 17719
      },
      "writtenOn": "2022-12-07T13:13:08Z",
      "side": 1,
      "message": "With \"it must not happen that ...\", do you mean it is not allowed to happen but it can happen unless the API contract is followed?\n\nI think it is more error-safe to check `speech_probability.has_value()` than to add a comment in the .h file to instruct the caller to follow the API contract. Can we even add both? Even in the case of new API contract instructions we\u0027ll need to revise the docstring once the transient suppression has been removed. Meanwhile, DCHECK is not evaluated outside debug builds so it doesn\u0027t protect from crashes. DCHECK [\"is useful if evaluating ... is expensive and the expected cost of failing to detect the violated assumption is acceptable\"](https://source.chromium.org/chromium/chromium/src/+/main:third_party/webrtc/rtc_base/checks.h;drc\u003d9445f434ac5f24b27d1dc842c564d8aab8890590;l\u003d79).",
      "parentUuid": "f7cef691_150d7528",
      "range": {
        "startLine": 226,
        "startChar": 8,
        "endLine": 226,
        "endChar": 27
      },
      "revId": "329c1944a64b1a906706e0a01fb9d3126e8cf018",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c7c47c15_bb2d4d2f",
        "filename": "modules/audio_processing/gain_controller2.h",
        "patchSetId": 7
      },
      "lineNbr": 25,
      "author": {
        "id": 17719
      },
      "writtenOn": "2022-12-06T13:17:13Z",
      "side": 1,
      "message": "Also `#include \"modules/audio_processing/include/audio_frame_view.h\"` from adaptive_digital_gain_controller.h?",
      "range": {
        "startLine": 23,
        "startChar": 0,
        "endLine": 25,
        "endChar": 65
      },
      "revId": "329c1944a64b1a906706e0a01fb9d3126e8cf018",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "3eb6d9aa_20643060",
        "filename": "modules/audio_processing/gain_controller2.h",
        "patchSetId": 7
      },
      "lineNbr": 25,
      "author": {
        "id": 5122
      },
      "writtenOn": "2022-12-07T08:47:26Z",
      "side": 1,
      "message": "Thanks for checking. It\u0027s included in gain_controller2.cc, no need to include it here (unused in this header file).",
      "parentUuid": "c7c47c15_bb2d4d2f",
      "range": {
        "startLine": 23,
        "startChar": 0,
        "endLine": 25,
        "endChar": 65
      },
      "revId": "329c1944a64b1a906706e0a01fb9d3126e8cf018",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767"
    }
  ]
}