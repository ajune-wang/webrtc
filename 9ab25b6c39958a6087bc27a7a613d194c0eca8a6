{
  "comments": [
    {
      "key": {
        "uuid": "cfcd879c_6c48870c",
        "filename": "video/video_send_stream_tests.cc",
        "patchSetId": 2
      },
      "lineNbr": 1894,
      "author": {
        "id": 7332
      },
      "writtenOn": "2019-08-23T03:27:21Z",
      "side": 1,
      "message": "Potential segfault here (heap-use-after-free).\nFor some reason, this task can be called **after** the DestroyCalls() task, both invoked from the thread \u0027CallTestTaskQue\u0027.",
      "revId": "9ab25b6c39958a6087bc27a7a613d194c0eca8a6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "591b5c74_ce6e6b6e",
        "filename": "video/video_send_stream_tests.cc",
        "patchSetId": 2
      },
      "lineNbr": 1894,
      "author": {
        "id": 5508
      },
      "writtenOn": "2019-08-23T14:38:55Z",
      "side": 1,
      "message": "Have you tried this patch and found that to be the case? If so, can you share the stack traces? (including for when DestroyCalls is called)",
      "parentUuid": "cfcd879c_6c48870c",
      "revId": "9ab25b6c39958a6087bc27a7a613d194c0eca8a6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e13865bf_f0d8e3c7",
        "filename": "video/video_send_stream_tests.cc",
        "patchSetId": 2
      },
      "lineNbr": 1894,
      "author": {
        "id": 7332
      },
      "writtenOn": "2019-08-23T15:29:23Z",
      "side": 1,
      "message": "I did exactly that (sanitizers are better than me to detect stuff).\nThe traces show when the tasks are invoked. I find it harder to track down when they are posted!\n\n\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\nWARNING: ThreadSanitizer: heap-use-after-free (pid\u003d257638)\n  Read of size 8 at 0x7b7800000048 by thread T1:\n    #0 operator-\u003e buildtools/third_party/libc++/trunk/include/memory:2620 (video_engine_tests+0x1119f87)\n    #1 webrtc::internal::Call::GetStats() const call/call.cc:970 (video_engine_tests+0x1119f87)\n    #2 operator() video/video_send_stream_tests.cc:1894 (video_engine_tests+0x8328ab)\n    #3 __invoke\u003c(lambda at ../../video/video_send_stream_tests.cc:1892:27) \u0026\u003e buildtools/third_party/libc++/trunk/include/type_traits:4425 (video_engine_tests+0x8328ab)\n    #4 __call\u003c(lambda at ../../video/video_send_stream_tests.cc:1892:27) \u0026\u003e buildtools/third_party/libc++/trunk/include/__functional_base:348 (video_engine_tests+0x8328ab)\n    #5 operator() buildtools/third_party/libc++/trunk/include/functional:1531 (video_engine_tests+0x8328ab)\n    #6 __call_impl\u003cstd::__1::__function::__alloc_func\u003c(lambda at ../../video/video_send_stream_tests.cc:1892:27), std::__1::allocator\u003c(lambda at ../../video/video_send_stream_tests.cc:1892:27)\u003e, void ()\u003e \u003e buildtools/third_party/libc++/trunk/include/functional:2014 (video_engine_tests+0x8328ab)\n    #7 operator() buildtools/third_party/libc++/trunk/include/functional:2127 (video_engine_tests+0x95f1c9)\n    #8 operator() buildtools/third_party/libc++/trunk/include/functional:2351 (video_engine_tests+0x95f1c9)\n    #9 RunLoop test/single_threaded_task_queue.cc:140 (video_engine_tests+0x95f1c9)\n    #10 webrtc::test::SingleThreadedTaskQueueForTesting::Run(void*) test/single_threaded_task_queue.cc:109 (video_engine_tests+0x95e789)\n    #11 Run rtc_base/platform_thread.cc:130 (video_engine_tests+0x8a8529)\n    #12 StartThread rtc_base/platform_thread.cc:67 (video_engine_tests+0x8a8529)\n\n  Previous write of size 8 at 0x7b7800000048 by thread T1:\n    #0 operator delete(void*) /b/swarming/w/ir/cache/builder/src/third_party/llvm/compiler-rt/lib/tsan/rtl/tsan_new_delete.cc:126 (video_engine_tests+0x409e2e)\n    #1 webrtc::internal::Call::~Call() call/call.cc:478 (video_engine_tests+0x1114461)\n    #2 operator() buildtools/third_party/libc++/trunk/include/memory:2338 (video_engine_tests+0x6438c7)\n    #3 reset buildtools/third_party/libc++/trunk/include/memory:2651 (video_engine_tests+0x6438c7)\n    #4 DestroyCalls test/call_test.cc:234 (video_engine_tests+0x6438c7)\n    #5 operator() test/call_test.cc:199 (video_engine_tests+0x6438c7)\n    #6 __invoke\u003c(lambda at ../../test/call_test.cc:191:24) \u0026\u003e buildtools/third_party/libc++/trunk/include/type_traits:4425 (video_engine_tests+0x6438c7)\n    #7 __call\u003c(lambda at ../../test/call_test.cc:191:24) \u0026\u003e buildtools/third_party/libc++/trunk/include/__functional_base:348 (video_engine_tests+0x6438c7)\n    #8 operator() buildtools/third_party/libc++/trunk/include/functional:1531 (video_engine_tests+0x6438c7)\n    #9 __call_impl\u003cstd::__1::__function::__alloc_func\u003c(lambda at ../../test/call_test.cc:191:24), std::__1::allocator\u003c(lambda at ../../test/call_test.cc:191:24)\u003e, void ()\u003e \u003e buildtools/third_party/libc++/trunk/include/functional:2014 (video_engine_tests+0x6438c7)\n    #10 operator() buildtools/third_party/libc++/trunk/include/functional:2127 (video_engine_tests+0x95f25c)\n    #11 operator() buildtools/third_party/libc++/trunk/include/functional:2351 (video_engine_tests+0x95f25c)\n    #12 operator() test/single_threaded_task_queue.cc:86 (video_engine_tests+0x95f25c)\n    #13 __invoke\u003c(lambda at ../../test/single_threaded_task_queue.cc:85:12) \u0026\u003e buildtools/third_party/libc++/trunk/include/type_traits:4425 (video_engine_tests+0x95f25c)\n    #14 __call\u003c(lambda at ../../test/single_threaded_task_queue.cc:85:12) \u0026\u003e buildtools/third_party/libc++/trunk/include/__functional_base:348 (video_engine_tests+0x95f25c)\n    #15 operator() buildtools/third_party/libc++/trunk/include/functional:1531 (video_engine_tests+0x95f25c)\n    #16 __call_impl\u003cstd::__1::__function::__alloc_func\u003c(lambda at ../../test/single_threaded_task_queue.cc:85:12), std::__1::allocator\u003c(lambda at ../../test/single_threaded_task_queue.cc:85:12)\u003e, void ()\u003e \u003e buildtools/third_party/libc++/trunk/include/functional:2014 (video_engine_tests+0x95f25c)\n    #17 operator() buildtools/third_party/libc++/trunk/include/functional:2127 (video_engine_tests+0x95f1c9)\n    #18 operator() buildtools/third_party/libc++/trunk/include/functional:2351 (video_engine_tests+0x95f1c9)\n    #19 RunLoop test/single_threaded_task_queue.cc:140 (video_engine_tests+0x95f1c9)\n    #20 webrtc::test::SingleThreadedTaskQueueForTesting::Run(void*) test/single_threaded_task_queue.cc:109 (video_engine_tests+0x95e789)\n    #21 Run rtc_base/platform_thread.cc:130 (video_engine_tests+0x8a8529)\n    #22 StartThread rtc_base/platform_thread.cc:67 (video_engine_tests+0x8a8529)\n\n  Thread T1 \u0027CallTestTaskQue\u0027 (tid\u003d145201, running) created by main thread at:\n    #0 pthread_create /b/swarming/w/ir/cache/builder/src/third_party/llvm/compiler-rt/lib/tsan/rtl/tsan_interceptors.cc:967 (video_engine_tests+0x39a59b)\n    #1 rtc::PlatformThread::Start() rtc_base/platform_thread.cc:87 (video_engine_tests+0x8a85d9)\n    #2 webrtc::test::SingleThreadedTaskQueueForTesting::SingleThreadedTaskQueueForTesting(char const*) test/single_threaded_task_queue.cc:36 (video_engine_tests+0x95e75f)\n    #3 webrtc::test::CallTest::CallTest() test/call_test.cc:57 (video_engine_tests+0x63a4a7)\n    #4 webrtc::VideoSendStreamTest::VideoSendStreamTest() video/video_send_stream_tests.cc:100 (video_engine_tests+0x8235d4)\n    #5 VideoSendStreamTest_RespectsMinTransmitBitrate_Test video/video_send_stream_tests.cc:1962 (video_engine_tests+0x832154)\n    #6 CreateTest third_party/googletest/src/googletest/include/gtest/internal/gtest-internal.h:460 (video_engine_tests+0x832154)\n    #7 testing::TestInfo::Run() gtest.cc:? (video_engine_tests+0xa4d600)\n    #8 Run third_party/googletest/src/googletest/src/gtest.cc:2680 (video_engine_tests+0xa4d600)\n    #9 testing::TestSuite::Run() third_party/googletest/src/googletest/src/gtest.cc:2822 (video_engine_tests+0xa4e276)\n    #10 testing::internal::UnitTestImpl::RunAllTests() third_party/googletest/src/googletest/src/gtest.cc:5342 (video_engine_tests+0xa609a6)\n    #11 testing::UnitTest::Run() gtest.cc:? (video_engine_tests+0xa5fff9)\n    #12 Run third_party/googletest/src/googletest/src/gtest.cc:4930 (video_engine_tests+0xa5fff9)\n    #13 RUN_ALL_TESTS third_party/googletest/src/googletest/include/gtest/gtest.h:2472 (video_engine_tests+0xc3b536)\n    #14 Run test/test_main_lib.cc:144 (video_engine_tests+0xc3b536)\n    #15 main test/test_main.cc:29 (video_engine_tests+0x64b4de)\n\nSUMMARY: ThreadSanitizer: heap-use-after-free buildtools/third_party/libc++/trunk/include/memory:2620 in operator-\u003e\n\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n*** SIGSEGV received at time\u003d1566527621 ***\nPC: @     0x5558f0434f94  (unknown)  webrtc::internal::Call::GetStats()\n    @     0x5558efd847d1        144  absl::WriteFailureInfo()\n    @     0x5558efd844c0         64  absl::AbslFailureSignalHandler()\n    @     0x5558ef6bc170  (unknown)  __tsan::CallUserSignalHandler()",
      "parentUuid": "591b5c74_ce6e6b6e",
      "revId": "9ab25b6c39958a6087bc27a7a613d194c0eca8a6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d7beb245_8fd63430",
        "filename": "video/video_send_stream_tests.cc",
        "patchSetId": 2
      },
      "lineNbr": 1894,
      "author": {
        "id": 5508
      },
      "writtenOn": "2019-08-23T17:14:31Z",
      "side": 1,
      "message": "Brilliant - thanks for that :D\n\nI\u0027m going to take another stab at this and I think that I can simplify the fix actually.",
      "parentUuid": "e13865bf_f0d8e3c7",
      "revId": "9ab25b6c39958a6087bc27a7a613d194c0eca8a6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "19185779_0e49d685",
        "filename": "video/video_send_stream_tests.cc",
        "patchSetId": 2
      },
      "lineNbr": 1956,
      "author": {
        "id": 5112
      },
      "writtenOn": "2019-08-23T14:55:53Z",
      "side": 1,
      "message": "nit: Should this be marked guarded by crit_?",
      "range": {
        "startLine": 1956,
        "startChar": 7,
        "endLine": 1956,
        "endChar": 31
      },
      "revId": "9ab25b6c39958a6087bc27a7a613d194c0eca8a6",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": true
    }
  ]
}