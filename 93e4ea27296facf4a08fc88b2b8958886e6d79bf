{
  "comments": [
    {
      "key": {
        "uuid": "6ab77d8b_51633235",
        "filename": "modules/video_coding/codecs/av1/libaom_av1_unittest.cc",
        "patchSetId": 3
      },
      "lineNbr": 104,
      "author": {
        "id": 5527
      },
      "writtenOn": "2020-05-07T12:08:05Z",
      "side": 1,
      "message": "WDYT about having a TestAv1Encoder with an \"std::optional\u003cEncodedImage\u003e Encode\" function, meaning it will return the encoded frame directly. Then you don\u0027t have to have a \"Decode(int frame_id, ...)\" to keep track of which frames we tried to decode/were successfully decoded.",
      "range": {
        "startLine": 104,
        "startChar": 30,
        "endLine": 104,
        "endChar": 43
      },
      "revId": "93e4ea27296facf4a08fc88b2b8958886e6d79bf",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "cbec6fd0_d1073e46",
        "filename": "modules/video_coding/codecs/av1/libaom_av1_unittest.cc",
        "patchSetId": 3
      },
      "lineNbr": 104,
      "author": {
        "id": 5019
      },
      "writtenOn": "2020-05-07T12:16:56Z",
      "side": 1,
      "message": "such TestAv1Encoder might be helpful, I\u0027ll try to add it and see if that makes test clearer,\n\nbut I still would like to list frame_ids we tried to decode/successfully decoded.\nI found it helpful in error message. like\nExpected to decode frames {1, 13, 25}, decoded frames {1, 13}\n\n(This message is very close to what I got for real while testing FullSVC locally. Was hard to understand what\u0027s going on until added exact frame ids.)",
      "parentUuid": "6ab77d8b_51633235",
      "range": {
        "startLine": 104,
        "startChar": 30,
        "endLine": 104,
        "endChar": 43
      },
      "revId": "93e4ea27296facf4a08fc88b2b8958886e6d79bf",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "46266eee_e8492054",
        "filename": "modules/video_coding/codecs/av1/libaom_av1_unittest.cc",
        "patchSetId": 3
      },
      "lineNbr": 104,
      "author": {
        "id": 5019
      },
      "writtenOn": "2020-05-07T15:27:28Z",
      "side": 1,
      "message": "I tried create TestAv1Encoder that returns std::optional\u003cEncodedImage\u003e\nbut didn\u0027t found how it can help.\nOne problem is that EncodeImage is not enough: for svc testing I\u0027ll need 2nd parameter of the callback too (see SvcEncoderCallback in https://webrtc-review.googlesource.com/c/src/+/174560/1/modules/video_coding/codecs/av1/libaom_av1_unittest.cc )\n2nd problem is technical: converting const EncodedImage\u0026 reference from a callback into a return parameter is non-trivial. (asuming single thread makes it much easier, but still need to somehow to pass it from callback obejct into main function. Which would involve at least one copy) That complexity doesn\u0027t seems worth it.",
      "parentUuid": "cbec6fd0_d1073e46",
      "range": {
        "startLine": 104,
        "startChar": 30,
        "endLine": 104,
        "endChar": 43
      },
      "revId": "93e4ea27296facf4a08fc88b2b8958886e6d79bf",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "eb6ac01d_eb63d1ec",
        "filename": "modules/video_coding/codecs/av1/libaom_av1_unittest.cc",
        "patchSetId": 3
      },
      "lineNbr": 104,
      "author": {
        "id": 5019
      },
      "writtenOn": "2020-05-07T15:41:19Z",
      "side": 1,
      "message": "one more thing, with spatial layering single Encode function would emit multiple EncodedImages.",
      "parentUuid": "46266eee_e8492054",
      "range": {
        "startLine": 104,
        "startChar": 30,
        "endLine": 104,
        "endChar": 43
      },
      "revId": "93e4ea27296facf4a08fc88b2b8958886e6d79bf",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b58ede83_d68621b5",
        "filename": "modules/video_coding/codecs/av1/libaom_av1_unittest.cc",
        "patchSetId": 3
      },
      "lineNbr": 104,
      "author": {
        "id": 5527
      },
      "writtenOn": "2020-05-07T15:52:35Z",
      "side": 1,
      "message": "\u003e I tried create TestAv1Encoder that returns std::optional\u003cEncodedImage\u003e\n\u003e but didn\u0027t found how it can help.\n\nThe idea was to make the tests more straightforward by avoiding callbacks.\n\n\u003e One problem is that EncodeImage is not enough: for svc testing I\u0027ll need 2nd parameter of the callback too (see SvcEncoderCallback in https://webrtc-review.googlesource.com/c/src/+/174560/1/modules/video_coding/codecs/av1/libaom_av1_unittest.cc )\n\nRight, yes, you would have to return a list of tuples of {EncodedImage, GenericFrameInfo}.\n\n\u003e 2nd problem is technical: converting const EncodedImage\u0026 reference from a callback into a return parameter is non-trivial. (asuming single thread makes it much easier, but still need to somehow to pass it from callback obejct into main function. Which would involve at least one copy) That complexity doesn\u0027t seems worth it.\n\nThe payload buffer is refcounted (https://source.chromium.org/chromium/chromium/src/+/master:third_party/webrtc/modules/video_coding/codecs/av1/libaom_av1_encoder.cc;l\u003d302;drc\u003da4c442574864d3f1d6d73c24a9fa31bf2640d550?originalUrl\u003dhttps:%2F%2Fcs.chromium.org%2F), so copying an EncodedImage is (relatively) cheap, or are you talking about some other complexity?",
      "parentUuid": "46266eee_e8492054",
      "range": {
        "startLine": 104,
        "startChar": 30,
        "endLine": 104,
        "endChar": 43
      },
      "revId": "93e4ea27296facf4a08fc88b2b8958886e6d79bf",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "d5cff4d3_33d87d48",
        "filename": "modules/video_coding/codecs/av1/libaom_av1_unittest.cc",
        "patchSetId": 3
      },
      "lineNbr": 104,
      "author": {
        "id": 5019
      },
      "writtenOn": "2020-05-07T16:52:09Z",
      "side": 1,
      "message": "ok, done. Might look too complicated for now, but likely make things cleaner when I\u0027ll add more tests.\n(as for performance... the test seems runs a bit faster now.)",
      "parentUuid": "b58ede83_d68621b5",
      "range": {
        "startLine": 104,
        "startChar": 30,
        "endLine": 104,
        "endChar": 43
      },
      "revId": "93e4ea27296facf4a08fc88b2b8958886e6d79bf",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": false
    }
  ]
}