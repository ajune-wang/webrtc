{
  "comments": [
    {
      "key": {
        "uuid": "09333fbb_0d492be1",
        "filename": "modules/audio_processing/audio_processing_impl.cc",
        "patchSetId": 1
      },
      "lineNbr": 681,
      "author": {
        "id": 5119
      },
      "writtenOn": "2019-12-03T09:51:32Z",
      "side": 1,
      "message": "I think it is problematic that the reinitialization depends on other submodules. This only works because \"InitializeEchoController\" is called before UpdateActiveSubmoduleStates. What if InitializeNoiseSuppressor (for example) depends on (for example) the gain controller, which is not reconfigured until further down in ApplyAgc1Config? This could be error prone, and the \"safe\" solution is to call UpdateActiveSubmoduleStates after every InitializeX call.\n\nI suggest trying to decouple the SubmoduleStates update and the reinit of submodules, maybe adjusting the config here to something like (much as I dislike modifying the config):\n\n// Ensure high pass filtering is always applied when the AEC requires it.\nconfig_.high_pass_filter.enabled \u003d config_.high_pass_filter.enabled ||\n    (aec3_used || echo_controller_enabled_ || blabla);",
      "range": {
        "startLine": 680,
        "startChar": 0,
        "endLine": 681,
        "endChar": 29
      },
      "revId": "6d791a74a521e735fdd3226ff23bf7122d1436c5",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0f92472e_309655ee",
        "filename": "modules/audio_processing/audio_processing_impl.cc",
        "patchSetId": 1
      },
      "lineNbr": 681,
      "author": {
        "id": 5125
      },
      "writtenOn": "2019-12-03T10:16:38Z",
      "side": 1,
      "message": "I think you are right in that this is a very fragile behavior. This is also now clear from the bots which pinpointed that the tests fail for DEBUG mode.\n\nI\u0027m not that happy to modify the config struct but I found another way to accomplish the desired effect.\n\nPTAL",
      "parentUuid": "09333fbb_0d492be1",
      "range": {
        "startLine": 680,
        "startChar": 0,
        "endLine": 681,
        "endChar": 29
      },
      "revId": "6d791a74a521e735fdd3226ff23bf7122d1436c5",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "56ee20fa_c3b7bee8",
        "filename": "modules/audio_processing/audio_processing_impl.cc",
        "patchSetId": 1
      },
      "lineNbr": 681,
      "author": {
        "id": 5119
      },
      "writtenOn": "2019-12-03T10:46:31Z",
      "side": 1,
      "message": "The new approach looks alright.\n\nAn alternative might be to update the submodule states struct at the top of ApplyConfig (based on the config, not the modules directly). Then it will be in sync with config_ throughout APM. Although that might have issues with if we cannot apply the config (for example, AGC2 validates its config and potentially changes how it initializes the AGC. The approach I suggest would still work, but if some other similar validation in the future toggles some behavior that submodulestates depends on, we would have to find a way to update submodulestates.)\n\nPerhaps the solution is to drop SubmoduleStates, and only query based on config_ (and some other pieces of APM state)? Since a lot of its purpose - tracking what modules are active - is now covered by config_.",
      "parentUuid": "0f92472e_309655ee",
      "range": {
        "startLine": 680,
        "startChar": 0,
        "endLine": 681,
        "endChar": 29
      },
      "revId": "6d791a74a521e735fdd3226ff23bf7122d1436c5",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "e0d18f8f_0e59f376",
        "filename": "modules/audio_processing/audio_processing_impl.cc",
        "patchSetId": 1
      },
      "lineNbr": 681,
      "author": {
        "id": 5125
      },
      "writtenOn": "2019-12-03T10:51:12Z",
      "side": 1,
      "message": "I tried moving it to the top, but that causes issues as the code for the updating of the submodules partly looks at what submodules are created, rather that at what is enabled in the config (an example is  that it checks whether noise suppression is active by looking at !!submodules_.noise_suppressor).\n\nI think your suggestion makes a lot of sense, but I think that that requires too many changes to do in this CL.",
      "parentUuid": "56ee20fa_c3b7bee8",
      "range": {
        "startLine": 680,
        "startChar": 0,
        "endLine": 681,
        "endChar": 29
      },
      "revId": "6d791a74a521e735fdd3226ff23bf7122d1436c5",
      "serverId": "58829da1-049c-39fb-b951-ebdcd0984767",
      "unresolved": false
    }
  ]
}